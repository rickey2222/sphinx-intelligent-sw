%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}


\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\setmainfont{DejaVu Serif}
\setsansfont{DejaVu Sans}
\setmonofont{DejaVu Sans Mono}



\usepackage[Bjornstrup]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=auto}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\contentsname}{目录:}}

\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}


\usepackage[titles]{tocloft}
\cftsetpnumwidth {1.25cm}\cftsetrmarg{1.5cm}
\setlength{\cftchapnumwidth}{0.75cm}
\setlength{\cftsecindent}{\cftchapnumwidth}
\setlength{\cftsecnumwidth}{1.25cm}


\title{微纳光学智能设计软件}
\date{2023 年 11 月 08 日}
\release{v1}
\author{Rickey}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{发行版本}
\makeindex
\begin{document}

\ifdefined\shorthandoff
  \ifnum\catcode`\=\string=\active\shorthandoff{=}\fi
  \ifnum\catcode`\"=\active\shorthandoff{"}\fi
\fi

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}


\sphinxstepscope


\chapter{软件平台简介}
\label{\detokenize{_u7b80_u4ecb/index:id1}}\label{\detokenize{_u7b80_u4ecb/index::doc}}
\sphinxstepscope


\section{智能软件平台建设}
\label{\detokenize{_u7b80_u4ecb/_u667a_u80fd_u8f6f_u4ef6_u5e73_u53f0_u5efa_u8bbe/index:id1}}\label{\detokenize{_u7b80_u4ecb/_u667a_u80fd_u8f6f_u4ef6_u5e73_u53f0_u5efa_u8bbe/index::doc}}
\sphinxAtStartPar
基于智能算法的微纳光学逆向设计平台构架如下图1.1所示，整个设计平台分为基本单元数据库、核心设计优化算法和用户接口三大部分。其中基本单元数据库储存了现有器件的设计参数和相应的光学响应，数据库中的数据可以直接用于特定的实际应用、为优化算法提供合理的初始设计或者作为深度学习模块的训练数据使用，数据库会随着设计平台的使用不断产生增量数据，进而扩展模型的设计能力。

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{overall_software}.png}





\sphinxAtStartPar
核心设计优化算法部分分为5个模块，每个模块中又包含各自的子模型。优化算法以数值仿真模块为基础，通过深度学习模块可以实现从结构到光学响应的快速端到端设计，牺牲部分精度实现快速多样性的设计结果；而梯度拓扑优化模块和全局搜索模块为迭代式算法，运行时间较长，但可以针对设计目标进行高精度优化；远场光传播模块是针对微纳光学器件的远场响应，进行解析或者半解析处理，提高模型的优化效率。

\sphinxAtStartPar
在用户接口部分，逆向设计平台将提供求解、设计和优化三个功能接口。求解接口主要用于器件光学响应的正向求解，既可以直接调用数值仿真模块进行精确模拟仿真，也可调用深度学习和远场传播模块进行快速光学响应的预测；设计接口则用于给定所需要的光学响应，逆向追溯满足条件的微纳光学结构；优化接口用于给定设计目标函数，对现有的初始设计进行优化，或者直接与逆向设计接口联合使用，对逆向设计给出的设计结果直接进行优化。

\sphinxAtStartPar
基于智能算法的微纳光学逆向设计软件平台将提供C++或Python等主流编程语言的接口，并以docker等操作系统级虚拟容器的形式部署到服务端。智能逆向设计平台服务将支持Windows、Linux等主流操作系统的调用，同时，根据当前主流商用光电子仿真软件（如Lumerical、CST等）的编程API，设计平台也将提供简洁的调用接口，保证在智能逆向设计中可以利用目前商用软件成熟的数据库和一些求解模块，对设计结果进行验证。

\sphinxAtStartPar
对于常规的超表面透镜、滤波器、偏振片等器件，智能微纳光学逆向设计软件将提供便捷的用户界面（UI），使用者只需输入待设计优化的目标参数，即可实现全自动化设计并输出最终的器件版图和性能预测，这将极大推动微纳光学器件的标准化设计流程。

\sphinxAtStartPar
同时，针对用户高度定制化的设计需求，智能逆向设计软件平台也将通过C++或Python等主流编程语言提供灵活的接口，用户可以通过编程接口方便地调用软件平台中的核心算法模块，从而根据自身需求设计定制超表面、硅基光电子器件、表面等离子体基元器件等多种微纳光学器件。

\sphinxstepscope


\section{核心设计优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/index:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/index::doc}}
\sphinxstepscope


\subsection{深度学习算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b::doc}}

\subsubsection{1.深度学习优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id2}}

\paragraph{1.1 神经网络模型}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id3}}

\subparagraph{1.1.1 模型简介}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id4}}
\sphinxAtStartPar
深度学习是机器学习的一个分支，这个概念源于人工神经网络的研究，神经网络通过组合低层特征形成更加抽象的高层表示特征，并利用这些特征来进行决策。


\sphinxAtStartPar
\sphinxincludegraphics{{1.11}.png}





\sphinxAtStartPar
如图1.1所示，含多个隐藏层的多层感知器就是一种深度学习结构。输入层指输入到神经网络的数据；隐藏层是数据处理的核心部分，数据将穿过隐藏层，并由许多权重调节；输出层是神经网络传递数据的结果，也是人们试图达到的目标。


\subparagraph{1.1.2 实例—用于预测光谱的前向预测模型}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id5}}
\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1.21}.png}





\sphinxAtStartPar
光学设计中的前向预测模型通常是输入光学器件结构，经神经网络输出相应的光学响应。在本模型中，前向预测模型的功能如图1.2所示。输入为64×64pixel表示的自由形状超表面结构; 输出为600\textasciitilde{}1200nm的波长范围内均匀采样61个波长点的不同极化方式的透射系数。其中实线为CST仿真的真实光谱，散点为前向预测模型的输出光谱。

\sphinxAtStartPar
具体的前向预测模型的网络结构示意图如下图1.3所示。


\sphinxAtStartPar
\sphinxincludegraphics{{1.3}.png}





\sphinxAtStartPar
\sphinxincludegraphics{{1.4}.png}





\sphinxAtStartPar
该模型的预测光谱的单点mse误差为0.0081，图1.4展示了前向预测模型的预测效果。其中实线为真实的透射谱，散点为前向预测模型输出的预测光谱。


\paragraph{1.2 深度生成模型}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id6}}

\subparagraph{1.2.1 模型简介}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id7}}
\sphinxAtStartPar
VAE(Variational Autoencoder,变分自动编码器)是一种深度生成模型，其模型如图1.5所示。通过编码器生成特征，然后解码器重构出原来的特征，并让重构出来的特征和输入的特征尽可能相似。


\sphinxAtStartPar
\sphinxincludegraphics{{1.5}.png}





\sphinxAtStartPar
VAE模型的损失函数由KL散度和重建误差两部分组成，KL散度用来衡量图形的真实分布与高斯分布的差异程度，重建误差用来衡量重建图像与输入图像的相似程度，两者均越小越好。通过结合KL散度和重建误差，VAE模型平衡了生成数据的多样性和生成数据与原始数据的相似性。


\subparagraph{1.2.2 实例—生成自由形状超表面结构}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6df1_u5ea6_u5b66_u4e60_u6a21_u5757/_u6df1_u5ea6_u5b66_u4e60_u6a21_u578b:id8}}
\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1.6}.png}





\sphinxAtStartPar
在本实例中，VAE模型用于超表面逆向设计的示意图如图1.6所示。将自由形状超表面结构输入编码器encoder中，输出其高斯分布的均值μ和标准差σ，经重采样后得到编码z，结合自由形状超表面结构的光谱一同输入到解码器decoder中，经decoder生成新的超表面结构。具体的网络结构如下图1.7所示。


\sphinxAtStartPar
\sphinxincludegraphics{{1.7}.png}







\sphinxstepscope


\subsection{数值仿真算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6570_u503c_u4eff_u771f_u6a21_u5757/_u6570_u503c_u4eff_u771f_u7b97_u6cd5:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6570_u503c_u4eff_u771f_u6a21_u5757/_u6570_u503c_u4eff_u771f_u7b97_u6cd5::doc}}

\subsubsection{1. 时域有限差分法（FDTD）}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6570_u503c_u4eff_u771f_u6a21_u5757/_u6570_u503c_u4eff_u771f_u7b97_u6cd5:fdtd}}
\sphinxAtStartPar
  FDTD在空间和时间上均对麦克斯韦方程组进行离散化处理，可以求解波的传播问题，是最为广泛应用的数值仿真方法。我们智能软件平台的FDTD数值仿真模块分为两种方式，一种是基于meep开源软件包，另一种是基于商业软件Lumerical FDTD进行时域有限差分方法进行电磁仿真。
时域电磁仿真只是在有限的计算量内随时间演化麦克斯韦方程组，本质是执行一种数值实验。这可用于计算各种有用的数量，主要应用包括：
\begin{itemize}
\item {} 
\sphinxAtStartPar
透射率和反射率光谱\textendash{}通过对短脉冲的相应进行傅里叶变换，一次模拟就可以产生宽带光谱上的散射振幅

\item {} 
\sphinxAtStartPar
谐振模式和频率\textendash{}通过分析系统对短脉冲的相应，可以提取有损和无损系统（包括博导和腔模式）的谐振模式的频率、衰减率和场模式。

\item {} 
\sphinxAtStartPar
场模式\textendash{}通过连续波输入响应任意源。

\end{itemize}


\subsubsection{2. 有限差分频域法（FDFD）}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6570_u503c_u4eff_u771f_u6a21_u5757/_u6570_u503c_u4eff_u771f_u7b97_u6cd5:fdfd}}
\sphinxAtStartPar
  FDFD认为待求解的系统由时谐信号激励，仅在空间上进行离散化处理求解稳态下的频率响应。软件采用的有限差分频域求解器是基于SPINS开源软件包，其中二维仿真采用求解器FDFD Local Matrix Solver，这是一个基于CPU的求解器，该求解器只需设置适当的矩阵方程并使用BLAS运行直接矩阵求解即可求解。因此，它对于小型2D问题快速且有效，但对于大型2D或3D问题却很慢。
三维求解器采用Maxwell\sphinxhyphen{}B求解器，它是基于GPU的有限差分频域求解器，这个求解器必须安装在至少具有一个NVIDIA GPU的机器上。对于使用者只关心几个波长的问题十分有效。


\subsubsection{3. 严格耦合波分析（RCWA）}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u6570_u503c_u4eff_u771f_u6a21_u5757/_u6570_u503c_u4eff_u771f_u7b97_u6cd5:rcwa}}
\sphinxAtStartPar
  RCWA是一种适用于求解周期性电磁场的算法，电磁波被展开为空间谐波（傅里叶级数），分立的空间谐波并不满足波动方程，但它们的叠加结果满足波动方程，主要可以用于研究各种周期性结构衍射特性分析。相比于FDTD和FDFD等其他数值方法，RCWA在速度上有明显优势。我们软件的RCWA数值仿真模块主要是基于torcwa的开源包进行仿真求解的。

\sphinxstepscope


\subsection{全局优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u5168_u5c40_u641c_u7d22_u4f18_u5316_u6a21_u5757/_u5168_u5c40_u4f18_u5316_u7b97_u6cd5:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u5168_u5c40_u641c_u7d22_u4f18_u5316_u6a21_u5757/_u5168_u5c40_u4f18_u5316_u7b97_u6cd5::doc}}

\subsubsection{1. 遗传算法（GA，Generative Algorithm）}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u5168_u5c40_u641c_u7d22_u4f18_u5316_u6a21_u5757/_u5168_u5c40_u4f18_u5316_u7b97_u6cd5:ga-generative-algorithm}}
\sphinxAtStartPar
遗传算法是应用最广泛的全局优化技术之一，多用于离散优化问题。它将问题的求解过程转换成类似生物进化中的染色体基因的交叉、变异等过程。在求解较为复杂的组合优化问题时,相对一些常规的优化算法,通常能够较快地获得较好的优化结果。

\sphinxAtStartPar
遗传算法中每一条染色体，对应着遗传算法的一个解决方案，一般我们用适应性函数来衡量这个解决方案的优劣。所以从一个基因组到其解的适应度形成一个映射。可以把遗传算法的过程看作是一个在多元函数里面求最优解的过程。

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1676378417248}.png}



\sphinxAtStartPar
遗传算法的基本运算过程如下：
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
初始化：设置进化代数计数器\(t=0\)，设置最大进化代数T，随机生成M个个体作为初始群体\(P(0)\)。

\item {} 
\sphinxAtStartPar
个体评价：计算群体\(P(t)\)中各个个体的适应度。

\item {} 
\sphinxAtStartPar
选择运算：将选择算子作用于群体。选择的目的是把优化的个体直接遗传到下一代或通过配对交叉产生新的个体再遗传到下一代。选择操作是建立在群体中个体的适应度评估基础上的。

\item {} 
\sphinxAtStartPar
交叉运算：将交叉算子作用于群体。遗传算法中起核心作用的就是交叉算子。

\item {} 
\sphinxAtStartPar
变异运算：将变异算子作用于群体。即是对群体中的个体串的某些基因座上的基因值作变动。群体\(P(t)\)经过选择、交叉、变异运算之后得到下一代群体\(P(t+1)\)。

\item {} 
\sphinxAtStartPar
终止条件判断：若\(t=T\) ，则以进化过程中所得到的具有最大适应度个体作为最优解输出，终止计算。

\end{enumerate}

\sphinxAtStartPar
遗传操作包括以下三个基本遗传算子：选择、交叉、变异。
\begin{itemize}
\item {} 
\sphinxAtStartPar
选择

\sphinxAtStartPar
从群体中选择优胜的个体，淘汰劣质个体的操作叫选择。

\item {} 
\sphinxAtStartPar
交叉

\sphinxAtStartPar
把两个父代个体的部分结构加以替换重组而生成新个体。这导致后代与父代样本具有一定程度的相似性。

\item {} 
\sphinxAtStartPar
变异

\sphinxAtStartPar
对群体中的个体串的某些基因座上的基因值作变动。这导致了样本彼此之间有一定程度的差异。

\end{itemize}


\subsubsection{2. 粒子群算法(PSO，Particle Swarm Optimization)}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u5168_u5c40_u641c_u7d22_u4f18_u5316_u6a21_u5757/_u5168_u5c40_u4f18_u5316_u7b97_u6cd5:pso-particle-swarm-optimization}}
\sphinxAtStartPar
粒子群算法适用于连续优化问题，是另一种群体智能优化算法，源于对鸟群捕食的行为研究 。

\sphinxAtStartPar
粒子群算法最初是受到飞鸟集群活动的规律性启发，进而利用群体智能建立的一个简化模型。粒子群算法在对动物集群活动行为观察基础上，利用群体中的个体对信息的共享使整个群体的运动在问题求解空间中产生从无序到有序的演化过程，从而获得最优解。
\begin{itemize}
\item {} 
\sphinxAtStartPar
粒子属性

\end{itemize}

\sphinxAtStartPar
在粒子群算法中，每个粒子具有两个属性：速度和位置。速度代表移动的快慢，位置代表移动的方向。

\sphinxAtStartPar
每个粒子都有一个由目标函数决定的适应值，并且知道自己到目前为止发现的最好位置\(pbest\)和现在的位置 \(x_i\)。这个可以看作是粒子自己的飞行经验。除此之外，每个粒子还知道到目前为止整个群体中所有粒子发现的最好位置\(gbest\)(gbest是pbest中的最优值)，这个可以看作是粒子同伴的经验。粒子就是通过自己的经验和同伴中最好的经验来决定下一步的运动。
\begin{itemize}
\item {} 
\sphinxAtStartPar
更新方式

\end{itemize}

\sphinxAtStartPar
粒子群算法初始化为一群随机粒子(随机解)，然后通过迭代找到最优解。在每一次的迭代中，粒子通过跟踪两个“极值”\(pbest，gbest\)来更新自己。在找到这两个最优值后，粒子通过下面的公式分别来更新自己的速度和位置。
\begin{equation*}
\begin{split}    v_i=v_i+c_1\times rand()\times (pbest_i-x_i)+c_2\times rand()\times (gbest_i-x_i)\end{split}
\end{equation*}\begin{equation*}
\begin{split}    x_i=x_i+v_i\end{split}
\end{equation*}\begin{quote}

\sphinxAtStartPar
\(rand()\)：介于\((0,1)\)之间的随机数

\sphinxAtStartPar
\(c_1\) 和 \(c_2\) ：学习因子，通常均设为2。
\end{quote}

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1676378498462}.png}





\sphinxAtStartPar
综上，粒子群算法的基本运算过程如下：
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
初始化一群例子(群体规模为\(N\))，包括随机位置和速度；

\item {} 
\sphinxAtStartPar
评价每个粒子的适应度；

\item {} 
\sphinxAtStartPar
对每个粒子，将其适应值与其经过的最好位置\(pbest\)作比较，如果较好，则将其作为当前的最好位置\(pbest\)；

\item {} 
\sphinxAtStartPar
对每个粒子，将其适应值与其经过的最好位置\(gbest\)作比较，如果较好，则将其作为当前的最好位置\(gbest\)；

\item {} 
\sphinxAtStartPar
更新每个例子的速度和位置；

\item {} 
\sphinxAtStartPar
终止条件判断：若 \(t=T\) ，则以进化过程中所得到的具有最大适应度个体作为最优解输出，终止计算。

\end{enumerate}

\sphinxstepscope


\subsection{梯度拓扑优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5::doc}}

\subsubsection{1. 逆向设计介绍}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id2}}

\paragraph{1.1 逆向设计算法框架介绍}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id3}}
\sphinxAtStartPar
  逆向设计是实现超紧凑、高性能、新功能集成硅光子器件极具吸引力的新型方法。逆向设计过程中，已知输入与输出参数，通过对设计区域参数的修改得到相对理想的结果。
  如图1.1(a)所示，在常规（前向）设计中，已知输入 \(x_n\)(n为自然数)，且输出 \(y_n\)与输入 \(x_n\)之间存在约束式\(F_n\),在设计中给定设计区参数\(ρ_n\),得到输出\(y_n=F_n(x_n,ρ_n)\)。
在对输出结果进行优化时，通过多次改变设计区参数\(ρ_n\)（如粒子群优化算法），得到依据于初始参数的最优解。
  如图1.1(b)所示，在逆向设计中，设计模型由方程组\(F_n(x_n,ρ_n)=y_n\)表示，已知输入\(x_n\)以及希望得到的输出\(y_n\),对\(F_n(x_n,ρ_n)=y_n\)求解，得到设计区参数\(\hat{p}_n\)。
在对输出结果进行优化时，通过多次比价输出\(\hat{y}_n\)与希望得到的输出\(y_n\)之间的差值，改变设计区参数\(\hat{p}_n\)，使输出结果接近输出\(y_n\),得到设计参数\(ρ_n\)的最优解。


\sphinxAtStartPar
\sphinxincludegraphics{{1.1}.png}






\paragraph{1.2 基于梯度下降的伴随法介绍}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id4}}
\sphinxAtStartPar
  伴随法是一种用于在数值优化问题中有效计算函数或算子的梯度的数值方法。基于梯度下降的伴随法具有迭代次数少，仿真时间短等优点。
  如图1.1.所示,在优化过程中，依据约束方程组\(F_n(x_n,y_n)\)构建度量函数\(G_n(x_n,ρ_n)\)，度量函数\(G_n\)用来描述设计参数\(\hat{ρ}_n\)时，对应的输出\(\hat{y}_n\),与目标输出\(y_n\)的距离，当\(G_n(x_n,ρ_n)\)取最小值时，即可认为取得了涉及区域的最优解。
  由于\(G_n(x_n,ρ_n)=min\)为不易求解的方程，考虑到其参数与约束条件\(F_n(x_n,ρ_n)\)相同，构建拉格朗日函数，对函数L关于\(ρ_n\)求解偏微分，当偏微分为零时，取得的含有拉格朗日乘子的等式即为伴随等式，伴随式在物理意义上等价于将所需的输出对场强的导数注入系统，并逆向运行系统得到的输出结果。
  对\(G_n(x_n,ρ_n)\)关于\(ρ_n\)求解偏微分，可得当对设计区参数\(ρ_n\)进项微小扰动时对输出结果的影响程度，即梯度。梯度在数学上等价于前向仿真在设计区得到的数值与伴随仿真的数值乘积的实部。梯度对着迭代次数减小，即可得到\(G_n(x_n,ρ_n)\)的最小值。

\sphinxincludegraphics{{1.2}.png}






\subsubsection{2. 基于密度的拓扑优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id5}}
\sphinxAtStartPar
  基于密度的拓扑优化对每个像素的设计进行参数化，使每个像素要么是“固体”（一种高的折射率材料），“空隙”（一种地折射率的材料），要么是两者之间的一些非物理插值。
一系列涉及过滤器和投影的转换用来逐步二值化设计，使其所有都是实的或者空的，通常也可以施加各种优化约束来强制执行设计规则（比如最小长度尺寸、面积和曲率）。
这种基于密度的拓扑优化算法是允许像素在优化过程中采用虚拟的插值材料“密度”，因此得到的目标函数（及其梯度）是平滑和连续可微的，这是基于梯度优化算法的一个重要要求，
相比于水平集的优化算法，它在求微分和优化过程中更胜一筹。


\paragraph{2.1 过滤}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id6}}
\sphinxAtStartPar
  拓扑优化中时常会伴随着网格依赖性、棋盘格以及灰度单元过多等现象。这些现象会导致实体与空洞交接模糊不清，影响材料识别，为了得到如下图2.1所示那样的清晰的优化构型，目前常用的解决方法是先通过过滤，密度过滤的主要思想是修改细胞的密度，从而影响目标器件性能，使其依赖于给定领域内的密度场。
滤波是通过使用滤波器函数和密度的卷积乘积来实现的。
但是过滤之后会导致实体与空洞交界处灰度单元的增加，所以还需要通过Heaviside投影得到清晰的优化构型。

\sphinxincludegraphics{{2.1}.png}






\paragraph{2.2 投影}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id7}}
\sphinxAtStartPar
  得到经过过滤的密度场之后，对其进行基于光滑的Heaviside函数的投影操作，得到投影后的密度。关于Heaviside函数的表达式如下：
\begin{equation*}
\begin{split}\bar{ρ}_i=\frac{tanh(βη)+tanh(β(\tilde{ρ}_i-η))}{tanh(βη)+tanh(β(1-η))}\end{split}
\end{equation*}
\sphinxAtStartPar
  其函数中的参数η为投影阈值，即当单元密度小于η时，则Heaviside函数将改单元的密度向0方向投影；反之，当单元密度大于η时，则Heaviside函数将该单元的密度向1方向投影。其中参数β控制着Heaviside函数在阈值参数η附近的陡峭程度，当β趋近于无穷时，Heaviside函数则接近为阶跃函数。


\subsubsection{3. 基于水平集的拓扑优化算法}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id8}}

\paragraph{3.1 水平集方法思想}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id9}}
\sphinxAtStartPar
  水平集的基本思想是将界面看成高一维空间中某一函数\(φ(x)\)的零水平集，同时界面的演化也扩充到高一维的空间中。我们将水平集函数按照它所满足的发展方程进行的演化或迭代，由于水平集函数不断进行演化，所以零水平集也在不断变化，当水平集演化趋于平稳时，演化停止，得到界面形状,如图3.1所示。


\sphinxAtStartPar
\sphinxincludegraphics{{3.1}.jpg}






\paragraph{3.2 水平集拓扑优化流程}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id10}}

\subparagraph{3.2.1 构建初始水平集函数}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id11}}
\sphinxAtStartPar
  在水平集方法中，设计边界由水平集函数\(φ(x)\)的零水平轮廓定义，结构是由水平集函数取正值的域定义，进行材料的初始分布，即：
\begin{equation*}
\begin{split}     ρ=\begin{cases}0,& ∀x∈Ω；φ<0 \\ 1,& ∀x∈Ω；φ≥0 \end{cases}\end{split}
\end{equation*}

\subparagraph{3.3.2 构建拉格朗日函数}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id12}}
\sphinxAtStartPar
  根据设计目标和制造约束来构建拉格朗日函数，如下：
\begin{equation*}
\begin{split}    L(x)=J(x)+λx(V(x)-V_{max}) +\frac{1}{2Λ}(V(x)-V_{max})^2\end{split}
\end{equation*}
\sphinxAtStartPar
  其中，J(x)是优化目标函数，\(V(x)-V_{max}\)是给定的等式约束，λ和Λ是两个拉格朗日系数，更新策略为：
\begin{equation*}
\begin{split}    λ^{k+1}=λ^{k}+\frac{1}{Λ^k}(V(x)-V_{max})Λ^{k+1}=αΛ^k\end{split}
\end{equation*}
\sphinxAtStartPar
  其中，权重系数\(α∈(0,1)\)。


\paragraph{3.3.3 更新水平集函数}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id13}}
\sphinxAtStartPar
  最常见的水平集函数更新通过哈密顿\sphinxhyphen{}雅可比方程来解决：
\begin{equation*}
\begin{split}    \frac{\partial φ}{\partial t}+V(x)|\nabla φ| =0\end{split}
\end{equation*}
\sphinxAtStartPar
  在优化过程中，t是一个伪时间代表设计的演变，v是所谓的速度函数，或速度场，\(\nabla φ\)为水平集函数的梯度。边界的动态变化被水平集函数控制。根据新的水平集函数确定新的材料分布和新的拉格朗日函数。


\subsubsection{4. 添加制造限制约束}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id14}}
\sphinxAtStartPar
基于拓扑优化的光子逆向设计是一种强大的器件设计方法，在这种方法中，性能（如传输功率）可以优化数千或数百万自由度，表征制造器件的每个“像素”，允许完全意想不到的设计与前所未有的性能出现。然而，拓扑优化的巨大设计自由必须受到实际制造过程的限制，能满足那些商业半导体铸造厂的工艺约束，如图4.1所示。因此，本软件基于经典的密度的拓扑优化框架，施加了最小线宽、线间隔和曲率，最小面积和最小封闭面积约束，所有这些都没有实现任何额外的重新参数化。

\sphinxincludegraphics{{4.1}.png}




\paragraph{4.1 添加最小线宽，最小间隙，最小曲率半径约束}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id15}}
\sphinxAtStartPar
在拓扑的固体和空隙区域上强制执行最小的长度尺度。这些特殊的约束完全对应于一个铸造厂的设计规则手册的最小线宽和最小线间隔约束。约束通过识别拐点区域来工作，这些区域决定了在战略选择的侵蚀和扩张后设计拓扑是否保持不变。如果拓扑结构是一致的（即没有额外的“孔”或“岛”），那么就满足了长度尺度。强制执行实现此过程的优化约束需要一个指示符函数能够识别拐点区域和过滤器核和必要的侵蚀/膨胀之间的已知关系，最小线宽约束\(g_{Lw}≤0\)由该函数描述：
\begin{equation*}
\begin{split}g_{Lw}=\frac{1}{n}\sum_{i∈N} I_i^{Lw}(ρ_i)·[min{(\tilde{\rho_i}-η_e),0}]^2\end{split}
\end{equation*}
\sphinxAtStartPar
其中，\(I_{i}L_{W(ρ)}\)是一个指示函数，用来识别固相的变化区域：
\begin{equation*}
\begin{split}I_i^{Lw}(\rho)=\bar{\rho}·exp(-c\left| \nabla{\tilde{\rho}} \right|^2)\end{split}
\end{equation*}
\sphinxAtStartPar
其中，c是指示指标函数的“强度”的阻尼项。最小线间隔约束，\(g_{LS}\)≤0，用一个类似的函数来描述:
\begin{equation*}
\begin{split}g_{Ls}=\frac{1}{n}\sum_{i∈N} I_i^{Ls}(ρ_i)·[min{(\tilde{\rho_i}-η_d),0}]^2\end{split}
\end{equation*}
\sphinxAtStartPar
其中，\(I_{i}L_{S(ρ)}\)是一个指示函数，用来识别空隙阶段的变化区域：
\begin{equation*}
\begin{split}I_i^{Ls}(\rho)=(1-\bar{\rho})·exp(-c\left| \nabla{\tilde{\rho}} \right|^2)\end{split}
\end{equation*}
\sphinxAtStartPar
要从铸造的最小线宽\(lw\)和最小间距\(ls\)确定\(η_{e}\)和\(η_{d}\)，以下关系保持:
\begin{equation*}
\begin{split}\eta_e = \begin {cases} \frac{1}{4}(\frac{lw}{R})^2+\frac{1}{2}, & \frac{lw}{R}∈[0,1]  \\  -\frac{1}{4}(\frac{lw}{R})^2+\frac{lw}{R}, & \frac{lw}{R}∈[1,2]   \\ 1,   & \frac{lw}{R}∈[2，∞）    \end {cases}\end{split}
\end{equation*}\begin{equation*}
\begin{split}\eta_d = \begin {cases} \frac{1}{2}- \frac{1}{4}(\frac{ls}{R})^2, & \frac{ls}{R}∈[0,1]  \\  1+\frac{1}{4}(\frac{ls}{R})^2-\frac{ls}{R}, & \frac{ls}{R}∈[1,2]   \\ 0,   & \frac{ls}{R}∈[2，∞）    \end {cases}\end{split}
\end{equation*}
\sphinxAtStartPar
这里的\(R\)是用户指定的圆锥形滤波器的半径。这允许人们任意选择滤波器的半径，并从上述关系中推导出后续的阈值参数（\(η_{e}\)和\(η_{d}\)）。选择更小的半径允许较小的特征，但代价是潜在地“加强”相应的优化问题（即，约束Hessian可能有较大的条件数）。\(η_{e}\)和\(η_{d}\)的典型值分别为0.75和0.25，对应于\(R = 2lw = 2ls\)。

\sphinxAtStartPar
最后，我们注意到线宽和线空间约束也对固体和空隙区域的相应最小曲率进行了隐式约束。假设使用圆形滤波器并且满足约束，得到的拓扑不能包含直径小于相应长度尺度的圆形元素（例如，固体区域的线宽和空隙区域的线间距）。因此，相应的最小曲率半径\(k_{w,s}\)被定义为:
\begin{equation*}
\begin{split}k_{w,s} = \frac{l_{w,s} }{2}\end{split}
\end{equation*}

\paragraph{4.2 添加最小面积和封闭面积约束}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u6a21_u5757/_u68af_u5ea6_u62d3_u6251_u4f18_u5316_u7b97_u6cd5:id16}}
\sphinxAtStartPar
接下来，是对二维平面的约束，首先，指示器函数识别违反最小面积约束的区域（“岛屿”）和违反最小封闭面积约束的区域（“洞”）。接下来，每个约束都将鼓励优化器通过局部侵蚀（对于岛屿）或局部扩张（对于孔洞）来消除破坏区域。下图说明了一个样本设计（图4.2(a)）上的最小面积约束函数，使用图像分割算法识别违反规则的区域（图4.2(c)），不违反规则的区域保留，违反的区域根据我们设计的大小进行约束（图4.2(b)）。


\sphinxAtStartPar
\sphinxincludegraphics{{4.2}.png}





\sphinxstepscope


\subsection{远场传播模块}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id1}}\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents::doc}}

\subsubsection{1. 基尔霍夫衍射与瑞利\sphinxhyphen{}索末菲衍射}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id2}}
\sphinxAtStartPar
惠更斯\sphinxhyphen{}菲涅耳原理可表述为：波面上的每一点都可以看作一个发出球面次级扰动（子波）的次级波源，波场中任一点的扰动，都可看作是所有次级波源所造成的次级扰动的相干叠加。

\sphinxAtStartPar
对于其数学表达式，根据下图进行描述：

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1676289189304}.png}





\sphinxAtStartPar
考虑光源 \(S\)发出的球面波对 \(P\) 点的作用。

\sphinxAtStartPar
选取 \(S\) 与 \(P\) 之间的一个波面 \(\Sigma\) ，用这个波面上各点发出的子波在 \(P\) 点相干叠加的结果表示 \(S\) 对 \(P\) 的作用。

\sphinxAtStartPar
设 \(S\)  在 \(\Sigma'\) 上任一点 \(Q\) 的复振幅为
\(\tilde{E}_Q=\frac{A}{E}e^{ikR}\)
其中 \(A\)  是距离 \(S\)  单位距离处的振幅， \(R\)  是波面 \(\Sigma'\) 的半径.

\sphinxAtStartPar
另外，在 \(Q\) 点取波面的面元 \$d\textbackslash{}sigma\$ ，菲涅耳认为， \(d\sigma\) 发出的子波在 \(P\) 点产生的复振幅与入射波在面元上的复振幅 \(\tilde{E}_Q\)，面元大小 \(d\sigma\) ，倾斜因子\$K(\textbackslash{}theta)\$成正比。
\begin{quote}

\sphinxAtStartPar
注：倾斜因子\(K(\theta)\) 表示子波的振幅随面元法线 \(QP\) 的夹角 \(\theta\)的变化，其中 \(\theta\) 称为衍射角。
\end{quote}

\sphinxAtStartPar
综上， \(d\sigma\)  在 \(P\) 点的复振幅可表示为
\(d\tilde{E}(P)=CK(\theta)\frac{Ae^{ikR}e^{ikr}}{Rr}d\sigma\)
\begin{quote}

\sphinxAtStartPar
其中 \(C\) 是常数，\(R\)是 \(QP\) 间的距离
\end{quote}

\sphinxAtStartPar
那么在上图中\(ZZ\)间的波面 \(Σ\)上（光孔范围内），各面元发出的子波对 \(P\) 点产生复振幅的总和为
\(\tilde{E}(P)=C\frac{Ae^{ikR}}{R}\iint_{\Sigma}{\frac{e^{ikr}}{r}K(\theta)d\sigma}\)

\sphinxAtStartPar
实际上，上式当中选取的积分的面并不仅限于波面，可以更一般地选取 \(SP\) 之间任何一个曲面（或平面），假设 \(S\) 在所选取的面上的复振幅分布为 \(\tilde{E}(Q)\) ，那么上式化为
\(\tilde{E}(P)=C\iint_{\Sigma}{\tilde{E}(Q)\frac{e^{ikr}}{r}K(\theta)d\sigma}\)

\sphinxAtStartPar
不同的倾斜因子对应不同的公式：
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
基尔霍夫公式

\end{enumerate}

\sphinxAtStartPar
\(K(\theta)=\frac{cos(\theta)+1}{2}\)
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{1}
\item {} 
\sphinxAtStartPar
第一种瑞利\textendash{}索末菲公式

\end{enumerate}

\sphinxAtStartPar
\(K(\theta)=cos(\theta)\)
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{2}
\item {} 
\sphinxAtStartPar
第二种瑞利\textendash{}索末菲公式

\end{enumerate}

\sphinxAtStartPar
\(K(\theta)=1\)

\sphinxAtStartPar
在实际问题中，\(\theta\)通常较小，三个公式的倾斜因子均接近1。


\subsubsection{2. 菲涅尔衍射}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id3}}

\paragraph{傍轴近似}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id4}}
\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{1676293738928}.png}





\sphinxAtStartPar
在傍轴情况（当光束发散较小且观测区域的宽度远小于光传播距离）下，积分函数 \(\frac{e^{jkr}}{r}\) 中的分母 \(r\) 可以由 \(z_1\) 来代替，因为这对于光波振幅没有大的影响。但 \(r\)  的变化对相位影响依然不可忽略，因此在复指数当中应保留。

\sphinxAtStartPar
故衍射公式改写为：
\(\tilde{E}(P)=\frac{1}{i\lambda d}\iint_{\Sigma}{\tilde{E}(Q)e^{ikr}d\sigma}\)


\paragraph{菲涅尔近似}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id5}}
\sphinxAtStartPar
对 \(e^{jkr}\) 中的 \(r\) 进行泰勒展开，
\(r\approx z_1[1+\frac{(x-x_1)^2+(y-y_1)^2}{2z_1^2}-\frac{[(x-x_1)^2+(y-y_1)^2]^2}{8z_1^4}+\cdot\cdot\cdot]\)
第两项之后的值过小，只保留泰勒展开的前两项，故
\(r\approx z_1+\frac{(x-x_1)^2+(y-y_1)^2}{2z_1}\)
这种近似就是\sphinxstylestrong{菲涅耳近似}，在菲涅耳近似条件下对衍射现象的研究称为\sphinxstylestrong{菲涅耳衍射}：
\(\tilde{E}(x,y)=\frac{e^{ikr}}{i\lambda z_1}\iint_{-\infty}^{+\infty}{\tilde{E}(x_1,y_1)e^{\frac{ik}{2z_1}[(x-x_1)^2+(y-y_1)^2]}dx_1dy_1}\)


\subsubsection{3. 夫琅禾费衍射}
\label{\detokenize{_u7b80_u4ecb/_u6838_u5fc3_u8bbe_u8ba1_u4f18_u5316_u7b97_u6cd5/_u8fdc_u573a_u4f20_u64ad_u6a21_u5757/contents:id6}}
\sphinxAtStartPar
在菲涅耳近似的基础上，如果光孔屏与接收屏的距离更远，则可以得到更进一步的近似。

\sphinxAtStartPar
在菲涅尔近似中，
\(r= z_1+\frac{x^2+y^2}{2z_1}-\frac{xx_1+yy_1}{z_1}+\frac{x_1^2+y_1^2}{2z_1}\)
其中，其中第四项取决于光孔线度 \(x_1^2+y_1^2\)相对于两屏间的距离\(z_1\)的大小。当 \$z\_1\$ 充分大，以至于第四项对相位的影响远小于 \(\pi\) 时，第四项可以忽略，则近似认为：
\(r= z_1+\frac{x^2+y^2}{2z_1}-\frac{xx_1+yy_1}{z_1}\)
这就是\sphinxstylestrong{夫琅和费近似}，在夫琅禾费近似条件下对衍射现象的研究称为\sphinxstylestrong{夫琅禾费衍射}。

\sphinxAtStartPar
那么将 \(r\) 的近似式代入衍射公式得到：
\(\tilde{E}(x,y)=\frac{e^{ikr}}{i\lambda z_1}e^{\frac{ik}{2z_1}{x^2+y^2}}\iint_{-\infty}^{+\infty}{\tilde{E}(x_1,y_1)e^{-i2\pi(x_1\frac{x}{\lambda z_1}+y_1\frac{y}{\lambda z_1})}dx_1dy_1}\)

\sphinxstepscope


\chapter{软件安装}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:id1}}\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index::doc}}
\sphinxAtStartPar
现阶段微纳光学智能设计软件安装是将不同算法环境下/不同Dockerfile制作的\sphinxstylestrong{Docker镜像}部署到Linux主机或虚拟机，通过启动yml文件来运行智能设计软件。因此本地Linux主机或虚拟机需安装Docker和Docker\sphinxhyphen{}compose环境.


\section{什么是Docker？}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:docker}}
\sphinxAtStartPar
Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。

\sphinxAtStartPar
因此Docker可以屏蔽环境差异，只要程序被Docker打包后，那么无论运行在什么环境下程序的行为都是一致的，可以做到真正实现“build once, run everywhere”。

\sphinxAtStartPar
此外Docker的另一个好处就是快速部署，一个原因是容器启动速度非常快，另一个原因在于只要确保一个容器中的程序正确运行，那么你就能确信无论在生产环境部署多少都能正确运行。

\sphinxAtStartPar
Docker包括三个基本概念：
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{镜像（Image）}：Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:16.04 就包含了完整的一套 Ubuntu16.04 最小系统的 root 文件系统。

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{容器（Container）}：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{仓库（Repository）}：仓库可看成一个代码控制中心，用来保存镜像。一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 \textless{}仓库名\textgreater{}:\textless{}标签\textgreater{} 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签。

\end{itemize}


\section{Linux本地安装Docker engine及Docker compose}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:linuxdocker-enginedocker-compose}}
\sphinxAtStartPar
根据本地Linux系统选择对应的docker engine及docker\sphinxhyphen{}compose版本进行安装，下载链接：\sphinxstylestrong{\sphinxhref{https://download.docker.com/linux/ubuntu/dists/}{ubuntu系统安装docker engine}%
\begin{footnote}[1]\sphinxAtStartFootnote
\sphinxnolinkurl{https://download.docker.com/linux/ubuntu/dists/}
%
\end{footnote}}，\sphinxstylestrong{\sphinxhref{https://download.docker.com/linux/centos/7/x86\_64/stable/Packages/}{centos系统安装docker engine}%
\begin{footnote}[2]\sphinxAtStartFootnote
\sphinxnolinkurl{https://download.docker.com/linux/centos/7/x86\_64/stable/Packages/}
%
\end{footnote}}，\sphinxstylestrong{\sphinxhref{https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-linux-x86\_64}{Linux安装docker\sphinxhyphen{}compose}%
\begin{footnote}[3]\sphinxAtStartFootnote
\sphinxnolinkurl{https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-linux-x86\_64}
%
\end{footnote}}。

\sphinxAtStartPar
\sphinxstylestrong{Docker Engine}是Docker的核心组件，它是一个轻量级的容器管理工具，可以在Linux、Windouws和macOS上运行。Docker Engine通过使用容器技术将应用程序及其所有依赖打包成可移植的容器，从而实现了应用程序在不同环境中的快速部署和运行。

\sphinxAtStartPar
\sphinxstylestrong{Docker Compose}是一个工具，用于定义和运行多个Docker容器的应用程序。它使用YAML文件来定义容器、网络、数据卷等，并提供一组命令来管理这些资源。Docker Compose可以在单个主机上运行多个容器，也可以在多个主机上运行容器。用户可以使用docker\sphinxhyphen{}compose up命令来启动所有容器，使用docker\sphinxhyphen{}compose down命令来停止所有容器。


\section{启动微纳光学智能设计软件}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:id2}}
\sphinxAtStartPar
通过Git命令拉取微纳光学智能设计软件后端代码，进入下载文件夹后open terminal执行：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{docker}\PYG{o}{\PYGZhy{}}\PYG{n}{compose} \PYG{o}{\PYGZhy{}}\PYG{n}{f} \PYG{n}{docker}\PYG{o}{\PYGZhy{}}\PYG{n}{compose}\PYG{o}{\PYGZhy{}}\PYG{n}{production}\PYG{o}{.}\PYG{n}{yml} \PYG{n}{up}
\end{sphinxVerbatim}

\sphinxAtStartPar
启动软件后会创建多个容器：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{p}{[}\PYG{o}{+}\PYG{p}{]} \PYG{n}{Running} \PYG{l+m+mi}{4}\PYG{o}{/}\PYG{l+m+mi}{4}
 \PYGZbs{}\PYG{n}{u283f} \PYG{n}{Network} \PYG{n}{sd0523b\PYGZus{}default}        \PYG{n}{Created}                                  \PYG{l+m+mf}{0.3}\PYG{n}{s}
 \PYGZbs{}\PYG{n}{u283f} \PYG{n}{Container} \PYG{n}{sd0523b}\PYG{o}{\PYGZhy{}}\PYG{n}{mongo}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}      \PYG{n}{Created}                                  \PYG{l+m+mf}{2.1}\PYG{n}{s}
 \PYGZbs{}\PYG{n}{u283f} \PYG{n}{Container} \PYG{n}{sd0523b}\PYG{o}{\PYGZhy{}}\PYG{n}{front}\PYG{o}{\PYGZhy{}}\PYG{n}{end}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}  \PYG{n}{Creat}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}                                 \PYG{l+m+mf}{2.1}\PYG{n}{s}
 \PYGZbs{}\PYG{n}{u283f} \PYG{n}{Container} \PYG{n}{web}                  \PYG{n}{Created}                                  \PYG{l+m+mf}{1.0}\PYG{n}{s}
\end{sphinxVerbatim}

\sphinxAtStartPar
对系统进行初始化：
\begin{itemize}
\item {} 
\sphinxAtStartPar
进入后端容器中，执行命令：docker exec \sphinxhyphen{}it web bash

\item {} 
\sphinxAtStartPar
创建软件的第一个管理员用户，管理员用户的用户名及密码可在拉取的代码test/api\_test/login.py文件中修改，执行命令：python test/api\_test/login.py

\sphinxAtStartPar
\sphinxstyleemphasis{要注意的是，需要进入web bash容器内部修改test/api\_test中的common.py文件里的HOST内容，可采用文件替换形式（docker cp）}

\end{itemize}

\sphinxAtStartPar
初始化软件后默认在HOST= ‘http://127.0.0.1/api’部署软件，也可以在服务器所在IP下登入软件页面
\sphinxincludegraphics{{软件安装/%E9%83%A8%E7%BD%B2%E6%88%90%E5%8A%9F}.png}




\section{更新微纳光学智能设计软件}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:id3}}
\sphinxAtStartPar
由于算法迭代以及公共接口进一步开发，微纳光学智能设计软件需要更新，更新步骤如下：
\begin{itemize}
\item {} 
\sphinxAtStartPar
关闭软件后台，在部署的Linux系统中后端文件夹下使用docker\sphinxhyphen{}compose\sphinxhyphen{}production.yml down，暂停容器运行

\item {} 
\sphinxAtStartPar
根据对应docker file制作最新版镜像（前端、后端以及meep镜像），本地制作完成后推送到镜像仓库中

\item {} 
\sphinxAtStartPar
在部署的Linux系统中下载最新版镜像（meep需要），或者在docker\sphinxhyphen{}compose\sphinxhyphen{}production.yml文件中更新前后端镜像地址

\item {} 
\sphinxAtStartPar
修改好yml文件后，需要重新启动软件，即docker\sphinxhyphen{}compose \sphinxhyphen{}f docker\sphinxhyphen{}compose\sphinxhyphen{}production.yml up

\item {} 
\sphinxAtStartPar
智能设计软件更新完毕，用户可正常访问微纳光学智能设计软件

\item {} 
\sphinxAtStartPar
在meep工程环境下更新meep镜像地址

\item {} 
\sphinxAtStartPar
联合仿真Windows环境中也需要重新下载后端文件夹

\end{itemize}


\section{联合仿真Windows环境部署}
\label{\detokenize{_u8f6f_u4ef6_u5b89_u88c5/index:windows}}
\sphinxAtStartPar
微纳光学智能设计软件能够实现与\sphinxstylestrong{主流商用光电子软件Lumerical及CST}联合仿真，由于商用软件安装环境为Windows系统与智能设计软件无法兼容，因此设计团队开发了agent服务，用来监听管理端的通知，当获取执行通知后会调用Python SDK执行相关的算法，运行结束通过Websocket返回管理端数据库。

\sphinxAtStartPar
Windows服务器需安装Lumerical及CST软件，并且在C:\textbackslash{}Windows\textbackslash{}System32\textbackslash{}drivers\textbackslash{}etc\textbackslash{}host文件中添加系统Web服务器以及MongoDB服务器的IP地址，格式如下：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}      \PYG{n}{mongo}
\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}\PYG{o}{.}\PYG{n}{xxx}      \PYG{n}{web}
\end{sphinxVerbatim}

\sphinxAtStartPar
下载安装\sphinxhref{https://www.python.org/ftp/python/3.7.9/python-3.7.9-amd64.exe}{python 3.7.9}%
\begin{footnote}[4]\sphinxAtStartFootnote
\sphinxnolinkurl{https://www.python.org/ftp/python/3.7.9/python-3.7.9-amd64.exe}
%
\end{footnote}和\sphinxhref{https://www.python.org/ftp/python/3.6.8/python-3.6.8-amd64.exe}{python 3.6.8}%
\begin{footnote}[5]\sphinxAtStartFootnote
\sphinxnolinkurl{https://www.python.org/ftp/python/3.6.8/python-3.6.8-amd64.exe}
%
\end{footnote}分别用于Lumerical以及CST。

\sphinxAtStartPar
安装好商用软件及对应的python环境后需要配置虚拟环境以及安装依赖：
\begin{itemize}
\item {} 
\sphinxAtStartPar
Windows服务器C盘目录下建立venv目录

\item {} 
\sphinxAtStartPar
执行命令激活python环境：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cd} \PYG{n}{c}\PYG{p}{:}\PYG{o}{/}\PYG{n}{venv}
\PYG{n}{python3}\PYG{l+m+mf}{.7}\PYG{n}{路径}\PYG{o}{/}\PYG{n}{python} \PYG{o}{\PYGZhy{}}\PYG{n}{m} \PYG{n}{venv} \PYG{n}{py37}
\PYG{n}{cd} \PYG{n}{c}\PYG{p}{:}\PYG{o}{/}\PYG{n}{venv}\PYG{o}{/}\PYG{n}{py37}\PYG{o}{/}\PYG{n}{Scripts}
\PYG{n}{activate}

\PYG{c+c1}{\PYGZsh{}python3.6同步设置}
\PYG{n}{cd} \PYG{n}{c}\PYG{p}{:}\PYG{o}{/}\PYG{n}{venv}
\PYG{n}{python3}\PYG{l+m+mf}{.6}\PYG{n}{路径}\PYG{o}{/}\PYG{n}{python} \PYG{o}{\PYGZhy{}}\PYG{n}{m} \PYG{n}{venv} \PYG{n}{py36}
\PYG{n}{cd} \PYG{n}{c}\PYG{p}{:}\PYG{o}{/}\PYG{n}{venv}\PYG{o}{/}\PYG{n}{py36}\PYG{o}{/}\PYG{n}{Scripts}
\PYG{n}{activate}
\end{sphinxVerbatim}

\item {} 
\sphinxAtStartPar
同样拉取后端代码到Windows本地服务器中，将main.py中的WINDOWS\_SERVER\_IP = ‘47.96.109.121’ 修改为Windows机器IP地址

\item {} 
\sphinxAtStartPar
安装项目依赖，执行代码：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}设置镜像源}
\PYG{n}{pip} \PYG{n}{config} \PYG{n+nb}{set} \PYG{k}{global}\PYG{o}{.}\PYG{n}{index}\PYG{o}{\PYGZhy{}}\PYG{n}{url} \PYG{n}{https}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{pypi}\PYG{o}{.}\PYG{n}{tuna}\PYG{o}{.}\PYG{n}{tsinghua}\PYG{o}{.}\PYG{n}{edu}\PYG{o}{.}\PYG{n}{cn}\PYG{o}{/}\PYG{n}{simple}
\PYG{n}{cd} \PYG{n}{sd0523}\PYG{o}{/}\PYG{n}{window\PYGZus{}server}\PYG{o}{/}
\PYG{c+c1}{\PYGZsh{}安装依赖(根据实际的requirements文件路径)}
\PYG{n}{pip} \PYG{n}{install} \PYG{o}{\PYGZhy{}}\PYG{n}{r} \PYG{n}{requirements}\PYG{o}{.}\PYG{n}{txt} \PYG{c+c1}{\PYGZsh{} python3.7环境 python3.6安装requirements36.txt}
\end{sphinxVerbatim}

\item {} 
\sphinxAtStartPar
最后运行Windows agent服务，CMD进入代码目录后执行：c:/venv/py37/Scripts/python main.py

\end{itemize}

\sphinxstepscope


\chapter{软件模块}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/index:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/index::doc}}
\sphinxAtStartPar
微纳光学智能设计软件是针对微纳光学器件仿真、数据库存储、器件优化算法以及光谱预测所设计的一套软件产品。软件提供Python编程接口，用户可以通过接口方便地调用软件平台中的器件仿真
或者核心算法模块，从而根据自身需求定制超表面、硅基光电子器件、表面等离子体基元器件等多种微纳光学器件。

\sphinxstepscope


\section{器件仿真}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5668_u4ef6_u4eff_u771f/contents:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5668_u4ef6_u4eff_u771f/contents::doc}}

\subsection{器件仿真模块介绍}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5668_u4ef6_u4eff_u771f/contents:id2}}
\sphinxAtStartPar
器件仿真建模需要用户将python建模代码输入至软件器件仿真模块的\sphinxstylestrong{代码区}中，前端采用CodeMirror在线代码编辑器使得用户可以在对应的算法环境中定义仿真模型，点击运行按钮即可进行器件仿真。与此同时模型会通过Three.js框架实现3D效果展示，在\sphinxstylestrong{模型展示区}中XY view、YZ view、XZ view二维平面以及Perspective View三维视角显示模型的视图，并且通过拖动鼠标及滑动鼠标滚轴可拖拽模型方向及缩放。


\sphinxAtStartPar
\sphinxincludegraphics{{device_simu1}.png}





\sphinxAtStartPar
现阶段软件可提供\sphinxstylestrong{FDTD底层算法结构}以及\sphinxstylestrong{与Lumerical、CST商业软件联动算法背景}，需要用户切换算法环境。具体的API接口使用方法及示例详见：\sphinxstylestrong{\sphinxhref{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E8\%BD\%AF\%E4\%BB\%B6API\%E6\%8E\%A5\%E5\%8F\%A3/contents.html}{软件API接口及示例}%
\begin{footnote}[6]\sphinxAtStartFootnote
\sphinxnolinkurl{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E8\%BD\%AF\%E4\%BB\%B6API\%E6\%8E\%A5\%E5\%8F\%A3/contents.html}
%
\end{footnote}}。

\sphinxAtStartPar
软件数据库中提供多种光学器件模型，点击加号即可加载器件，用户可在基础模型上进行修改。代码区显示的按钮从左到右依次表示：
\begin{itemize}
\item {} 
\sphinxAtStartPar
加号按钮：加载器件，器件存储于模型库中

\item {} 
\sphinxAtStartPar
暂停按钮：运算过程中点击，仿真强停止

\item {} 
\sphinxAtStartPar
开始按钮：开始进行仿真，模型构建

\item {} 
\sphinxAtStartPar
保存按钮：将代码区中的建模代码保存于器件中

\item {} 
\sphinxAtStartPar
另存为按钮：将代码区中的模型另存为新器件

\end{itemize}

\sphinxAtStartPar
器件仿真过程中的状态会实时显示在解释器输出窗口中，当运行完毕后会显示 \sphinxstyleemphasis{\sphinxstylestrong{FINISHED}}。模型相关要素会在\sphinxstylestrong{要素预览区}显示，包括模型结构、监视器、仿真区域等关键组件。运算过程中按照代码区编写存储的的性能图、模型图等显示在\sphinxstylestrong{性能展示区}，并会将图片保存至数据库对应的器件性能图中。

\sphinxAtStartPar
器件仿真过程展示在下图中，包括软件初始页面、模型建立中、模型仿真运行完毕后的结果展示、以及建模Perspective View全屏后的模型展示。


\sphinxAtStartPar
\sphinxincludegraphics{{device_simu_ex}.png}






\subsection{器件仿真tips}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5668_u4ef6_u4eff_u771f/contents:tips}}
\sphinxAtStartPar
因软件还在开发阶段，用户搭建模型需按照已给定的实例进行改写，或者使用软件提供的API进行模型构建：
\begin{itemize}
\item {} 
\sphinxAtStartPar
用户需按照API规则进行模型构建，对于监视器、模型构建等关键建模语句需提供必要的参数等

\item {} 
\sphinxAtStartPar
如若仿真过程中出现循环卡死或其他事件可点击代码上方的暂停按钮

\item {} 
\sphinxAtStartPar
代码区和性能展示区可左右、上下拖拽

\end{itemize}

\sphinxstepscope


\section{数据库}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents::doc}}

\subsection{数据库——材料库}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id2}}
\sphinxAtStartPar
智能软件系统提供用户定义的特殊材料，用户可自定义并上传特定材料在各个波段的性能数据并在模型构建中使用。
点击上传按钮即可添加以xls、xlsx及csv文件存储的材料折射率，文件第一列为波长，第二、第三列分别为材料的n、K值。如图所示，添加完成后的材料折射率会显示在折线图中。


\sphinxAtStartPar
\sphinxincludegraphics{{material}.jpg}





\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{data} \PYG{o}{=} \PYG{n}{device}\PYG{o}{.}\PYG{n}{get\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xxxx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} data数据提取}
\PYG{c+c1}{\PYGZsh{} data[\PYGZsq{}wave\PYGZsq{}]: 材料波长信息}
\PYG{c+c1}{\PYGZsh{} data[\PYGZsq{}n\PYGZsq{}]: 材料折射率n}
\PYG{c+c1}{\PYGZsh{} data[\PYGZsq{}k\PYGZsq{}]: 材料折射率k}
\end{sphinxVerbatim}


\subsection{数据库——器件库}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id3}}
\sphinxAtStartPar
在器件仿真及优化算法模块中用户运行的模型及结果按照类型保存在器件库中，器件表有模型结构参数信息、建模代码区域、模型预览图、性能图及计算结果展示：


\sphinxAtStartPar
\sphinxincludegraphics{{device}.jpg}




\begin{itemize}
\item {} 
\sphinxAtStartPar
结构参数包含模型结构的中心坐标，大小及高度

\item {} 
\sphinxAtStartPar
代码区域记录模型建模及参数提取所用代码

\item {} 
\sphinxAtStartPar
性能图存储模型仿真结果

\item {} 
\sphinxAtStartPar
计算结果记录模型仿真过程中的解释器输出

\end{itemize}


\subsubsection{器件库中添加/删除器件}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id4}}
\sphinxAtStartPar
软件支持用户新添加器件，点击器件表中的加号，输入器件名称及类型后点击保存即可在仿真模块中使用。用户也可以在器件仿真或优化算法模块中另存为功能添加器件。同时，拥有管理员权限的用户可以在数据库中删除器件。


\subsection{数据库——工程环境}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id5}}
\sphinxAtStartPar
软件系统工程环境表中保存了不同环境的镜像地址及域名，现可提供：
\begin{itemize}
\item {} 
\sphinxAtStartPar
基于MEEP\sphinxhyphen{}FDTD算法的镜像地址

\item {} 
\sphinxAtStartPar
用于光谱预测pytorch算法的镜像地址

\item {} 
\sphinxAtStartPar
用于RCWA算法的镜像地址

\item {} 
\sphinxAtStartPar
后续可添加其他算法镜像
商用软件Lumerical及CST无需添加。

\end{itemize}


\subsection{数据库——算法表}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id6}}
\sphinxAtStartPar
微纳光学智能设计软件支持上传算法扩展文件以及仿真使用的数据文件，算法表具备软件的文件管理功能。用户上传以ZIP格式的算法包后可在器件仿真、优化算法模块调用。


\sphinxAtStartPar
\sphinxincludegraphics{{add_doc}.jpg}





\sphinxAtStartPar
\sphinxincludegraphics{{add_doc2}.jpg}






\subsubsection{算法表中添加/下载算法}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u6570_u636e_u5e93/contents:id7}}
\sphinxAtStartPar
与器件库类似，算法表中算法压缩包可以通过点击加号按钮添加，右键“下载压缩包”可以下载算法。非管理员无编辑算法表的权限。

\sphinxstepscope


\section{优化算法}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u4f18_u5316_u7b97_u6cd5/contents:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u4f18_u5316_u7b97_u6cd5/contents::doc}}

\subsection{优化算法模块介绍}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u4f18_u5316_u7b97_u6cd5/contents:id2}}
\sphinxAtStartPar
所开发的基于人工智能的微纳光学器件设计方法融合了深度学习模型、梯度优化算法和启发式优化算法，充分利用深度学习模型的泛化性能、梯度优化算法的高校优化特点和启发式模型算法的全局搜索能力，可以对特定的设计目标按需设计，并面向具体需求将性能推向极限。软件优化算法模块包括 \sphinxstylestrong{\sphinxhref{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%80\%E4\%BB\%8B/\%E6\%A0\%B8\%E5\%BF\%83\%E8\%AE\%BE\%E8\%AE\%A1\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E6\%A2\%AF\%E5\%BA\%A6\%E6\%8B\%93\%E6\%89\%91\%E4\%BC\%98\%E5\%8C\%96\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%A2\%AF\%E5\%BA\%A6\%E6\%8B\%93\%E6\%89\%91\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95.html}{梯度拓扑优化算法模块}%
\begin{footnote}[7]\sphinxAtStartFootnote
\sphinxnolinkurl{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%80\%E4\%BB\%8B/\%E6\%A0\%B8\%E5\%BF\%83\%E8\%AE\%BE\%E8\%AE\%A1\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E6\%A2\%AF\%E5\%BA\%A6\%E6\%8B\%93\%E6\%89\%91\%E4\%BC\%98\%E5\%8C\%96\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%A2\%AF\%E5\%BA\%A6\%E6\%8B\%93\%E6\%89\%91\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95.html}
%
\end{footnote}} 中的伴随算法和水平集算法、\sphinxstylestrong{\sphinxhref{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%80\%E4\%BB\%8B/\%E6\%A0\%B8\%E5\%BF\%83\%E8\%AE\%BE\%E8\%AE\%A1\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E5\%85\%A8\%E5\%B1\%80\%E6\%90\%9C\%E7\%B4\%A2\%E4\%BC\%98\%E5\%8C\%96\%E6\%A8\%A1\%E5\%9D\%97/contents.html}{全局搜索优化模块}%
\begin{footnote}[8]\sphinxAtStartFootnote
\sphinxnolinkurl{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%80\%E4\%BB\%8B/\%E6\%A0\%B8\%E5\%BF\%83\%E8\%AE\%BE\%E8\%AE\%A1\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E5\%85\%A8\%E5\%B1\%80\%E6\%90\%9C\%E7\%B4\%A2\%E4\%BC\%98\%E5\%8C\%96\%E6\%A8\%A1\%E5\%9D\%97/contents.html}
%
\end{footnote}} 的粒子群算法等。

\sphinxAtStartPar
优化算法建模需要用户将python建模代码输入至软件优化算法模块的\sphinxstylestrong{优化算法代码区}中，前端采用CodeMirror在线代码编辑器使得用户可以在对应的算法环境中定义仿真模型，点击运行按钮即可进行迭代仿真。与此同时模型会通过Three.js框架实现3D效果展示，在\sphinxstylestrong{优化迭代展示区}中XY view、YZ view、XZ view二维平面显示模型的视图，同时器件优化进程会展示在\sphinxstylestrong{优化进程}窗口中。


\sphinxAtStartPar
\sphinxincludegraphics{{algorithm}.png}





\sphinxAtStartPar
软件数据库中提供多种优化算法模型，器件类型为优化示例，点击加号即可加载优化示例器件，用户可在基础模型上进行修改。代码区显示的按钮从左到右依次表示：
\begin{itemize}
\item {} 
\sphinxAtStartPar
加号按钮：加载优化算法示例，器件存储于模型库中

\item {} 
\sphinxAtStartPar
暂停按钮：运算过程中点击，仿真强停止

\item {} 
\sphinxAtStartPar
开始按钮：开始进行仿真，模型构建

\item {} 
\sphinxAtStartPar
保存按钮：将代码区中的建模代码保存于器件中

\item {} 
\sphinxAtStartPar
另存为按钮：将代码区中的模型另存为新器件

\end{itemize}

\sphinxAtStartPar
器件仿真过程中的状态会实时显示在解释器输出窗口中，当运行完毕后会显示 \sphinxstyleemphasis{\sphinxstylestrong{FINISHED}}。模型相关要素会在\sphinxstylestrong{要素预览区}显示，包括模型结构、监视器、仿真区域等关键组件。运算过程中按照代码区编写存储的的性能图、模型图等显示在\sphinxstylestrong{性能展示区}，并会将图片保存至数据库对应的器件性能图中。

\sphinxAtStartPar
器件仿真过程展示在下图中，显示的是1×2 power spliter的优化进程。


\sphinxAtStartPar
\sphinxincludegraphics{{软件模块介绍/优化算法/assets/%E4%BC%98%E5%8C%96}.png}






\subsection{优化算法tips}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u4f18_u5316_u7b97_u6cd5/contents:tips}}
\sphinxAtStartPar
因软件还在开发阶段，用户搭建模型需按照已给定的实例进行改写，或者使用软件提供的API进行模型构建：
\begin{itemize}
\item {} 
\sphinxAtStartPar
用户需按照API规则进行模型构建，对于监视器、模型构建等关键建模语句需提供必要的参数等

\item {} 
\sphinxAtStartPar
如若仿真过程中出现循环卡死或其他事件可点击代码上方的暂停按钮

\item {} 
\sphinxAtStartPar
代码区和性能展示区可左右、上下拖拽

\end{itemize}

\sphinxstepscope


\section{光谱预测}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5149_u8c31_u9884_u6d4b/contents:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5149_u8c31_u9884_u6d4b/contents::doc}}

\subsection{光谱预测模块介绍}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5149_u8c31_u9884_u6d4b/contents:id2}}
\sphinxAtStartPar
首先点击光谱预测模块，进入初始化页面：

\sphinxAtStartPar
\sphinxincludegraphics{{spectrum}.png}



\sphinxAtStartPar
本页面的各功能模块基于VAE模型开发（VAE模型介绍详见\sphinxhref{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%97\%E6\%B3\%95/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9E\%8B.html\#id6}{深度学习模块}%
\begin{footnote}[9]\sphinxAtStartFootnote
\sphinxnolinkurl{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E7\%AE\%97\%E6\%B3\%95/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9E\%8B.html\#id6}
%
\end{footnote}）。

\sphinxAtStartPar
本页面可分有三个功能区域：\sphinxstylestrong{输入区、模型区、结果展示区}。

\sphinxAtStartPar
输入区上传并展示传入VAE模型的光谱数据，模型区用于选择光谱预测的模型，结果展示区用于展示VAE模型的多样性预测结果。

\sphinxAtStartPar
以下是输入区和结果展示区中各模块的详细介绍：
\begin{itemize}
\item {} 
\sphinxAtStartPar
输入区\sphinxstylestrong{曲线模块}：绘制”配置点位“模块中上传的数据。

\item {} 
\sphinxAtStartPar
输入区\sphinxstylestrong{配置点位模块}：点击”上传模型”，上传本地csv文件。csv文件格式：光谱数据按列排列，第一列为横坐标数据，其余列为纵坐标数据。

\item {} 
\sphinxAtStartPar
结果展示区\sphinxstylestrong{结构预测结果模块}：展示VAE模型的多样性结果。”导出”按钮导出右侧光谱预测结果的CSV文件或版图GDS文件。

\item {} 
\sphinxAtStartPar
结果展示区\sphinxstylestrong{光谱预测结果模块}：展示左侧微纳光学结构对应的光谱预测结果，可与目标曲线直观进行对比。

\end{itemize}

\sphinxAtStartPar
\sphinxincludegraphics{{spectrum1}.png}



\sphinxAtStartPar
在模型区\sphinxstylestrong{配置模块}中：
\begin{itemize}
\item {} 
\sphinxAtStartPar
点击模型库：可添加/删除模型。点击“查看”，可上传模型中用到的模型文件。在模型中，通过“文件ID”调用上传的模型文件：

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}load generative model}
\PYG{n}{generative\PYGZus{}models} \PYG{o}{=} \PYG{n}{forecast}\PYG{o}{.}\PYG{n}{get\PYGZus{}model\PYGZus{}file}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{e3a30bccf854cd3efcde7efe51d82f78}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{file\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{generative\PYGZus{}models.py}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
模型库中保存模型名称及模型参数化描述，用户可以点击操作中的功能来使用、编辑、查看或者删除模型。
\sphinxincludegraphics{{spectrum2}.png}


\begin{itemize}
\item {} 
\sphinxAtStartPar
历时预测：保存历时预测结果。通过点击右上角的保存标志保存。

\item {} 
\sphinxAtStartPar
代码输入：点击模型后，在此处输入必要的参数，比如最大迭代测试、单点预测误差、制造限制等。

\item {} 
\sphinxAtStartPar
预测：运行模型代码，该模型对输入数据的预测。

\item {} 
\sphinxAtStartPar
解释器输出：运行模型代码时的python解释器输出。

\item {} 
\sphinxAtStartPar
可点击停止按钮强停止仿真过程

\end{itemize}


\subsection{光谱预测使用实例}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u5149_u8c31_u9884_u6d4b/contents:id3}}
\sphinxAtStartPar
本节以自由形状结构超表面的\sphinxhref{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E8\%BD\%AF\%E4\%BB\%B6\%E6\%A8\%A1\%E5\%9D\%97\%E4\%BB\%8B\%E7\%BB\%8D/\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9E\%8B.html}{VAE模型}%
\begin{footnote}[10]\sphinxAtStartFootnote
\sphinxnolinkurl{https://intelligent-software-design.readthedocs.io/zh\_CN/latest/\%E8\%BD\%AF\%E4\%BB\%B6\%E6\%A8\%A1\%E5\%9D\%97\%E4\%BB\%8B\%E7\%BB\%8D/\%E4\%BC\%98\%E5\%8C\%96\%E7\%AE\%97\%E6\%B3\%95/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9D\%97/\%E6\%B7\%B1\%E5\%BA\%A6\%E5\%AD\%A6\%E4\%B9\%A0\%E6\%A8\%A1\%E5\%9E\%8B.html}
%
\end{footnote}。

\sphinxAtStartPar
\sphinxstylestrong{Step1: 选择模型}


\sphinxAtStartPar
\sphinxincludegraphics{{spectrum3}.png}





\sphinxAtStartPar
\sphinxstylestrong{Step2: 上传输入模型的光谱数据，文件类型为csv}

\sphinxAtStartPar
该模型输入x的范围为600\sphinxhyphen{}1200，y的范围为0\sphinxhyphen{}1。


\sphinxAtStartPar
\sphinxincludegraphics{{spectrum4}.png}





\sphinxAtStartPar
上传后，点位可在y方向上拖动，右侧可查看拖动后点位的精确数值。模型预测读取的是实时的输入数据。

\sphinxAtStartPar
\sphinxstylestrong{Step3：预测结果}
\begin{itemize}
\item {} 
\sphinxAtStartPar
在代码输入窗口中输入必要参数：预测结构数目、最大迭代次数、单点预测误差阈值等。

\item {} 
\sphinxAtStartPar
点击预测按钮后开始预测结构并实时反馈结构对应的光谱结果。

\item {} 
\sphinxAtStartPar
待迭代循环完毕后可导出预测的光谱结果以及结构的GDS版图。


\end{itemize}

\sphinxAtStartPar
\sphinxincludegraphics{{spectrum5}.png}





\sphinxstepscope


\section{管理中心}
\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u7ba1_u7406_u4e2d_u5fc3/contents:id1}}\label{\detokenize{_u8f6f_u4ef6_u6a21_u5757_u4ecb_u7ecd/_u7ba1_u7406_u4e2d_u5fc3/contents::doc}}
\sphinxAtStartPar
软件管理中心模块对所有软件使用用户进行管理，拥有上传首页展示文档、新增用户以及赋予不同用户admin权限、修改密码等功能。仅有admin权限的用户可以修改数据库中标准模型代码及结果。没有admin权限的用户界面不包含管理中心模块。


\sphinxAtStartPar
\sphinxincludegraphics{{security}.png}





\sphinxstepscope


\chapter{软件API接口}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/contents:api}}\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/contents::doc}}
\sphinxstepscope


\section{软件设计框架及原理}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u8f6f_u4ef6_u8bbe_u8ba1_u6846_u67b6_u53ca_u539f_u7406/_u8f6f_u4ef6_u8bbe_u8ba1_u6846_u67b6_u53ca_u539f_u7406:id1}}\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u8f6f_u4ef6_u8bbe_u8ba1_u6846_u67b6_u53ca_u539f_u7406/_u8f6f_u4ef6_u8bbe_u8ba1_u6846_u67b6_u53ca_u539f_u7406::doc}}
\sphinxAtStartPar
基于智能算法的微纳光学逆向设计软件平台，包括微纳光学正向及逆向仿真功能。微纳智能软件可进行数值仿真，并且能够实现与主流商用光电子软件\sphinxhyphen{}Lumerical及CST联合仿真。用户可在软件代码区域使用统一API设计FDTD、Lumerical及CST环境所使用的模型。
软件是基于容器建立后端服务，通过调度容器对代码区域上下文的分析，将对应的算法片段发送到远程的执行软件执行，并且收集结果，将建模及结果展示在前端软件中。其中前端与调度容器通过HTTP协议传送信息，不同算法容器的计算结果保存在MongoDB中。


\sphinxAtStartPar
\sphinxincludegraphics{{软件API接口/软件设计框架及原理/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84}.png}





\sphinxstepscope


\section{仿真接口规范}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id1}}\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f::doc}}

\subsection{环境选择}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id2}}
\sphinxAtStartPar
微纳光学智能设计软件中，在软件代码区域根据仿真模型选择适配的运行环境。分别在建模代码的\sphinxstylestrong{初始}及\sphinxstylestrong{结尾}部分调用环境代码：
\begin{itemize}
\item {} 
\sphinxAtStartPar
FDTD环境：

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}
\begin{itemize}
\item {} 
\sphinxAtStartPar
lumerical环境：

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}
\begin{itemize}
\item {} 
\sphinxAtStartPar
CST环境：

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cst}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cst}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
环境外需要使用的数据需要在建模代码中使用时：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{data} \PYG{o}{=} \PYG{n}{need\PYGZus{}to\PYGZus{}save\PYGZus{}data}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{}将不同环境中需保存的数据存在变量data中（变量名可自定义），环境外使用data即可调用。}
\end{sphinxVerbatim}


\subsection{全局定义}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id3}}
\sphinxAtStartPar
微纳光学智能设计软件模型仿真需要定义全局变量，在代码区域中传入：
\begin{itemize}
\item {} 
\sphinxAtStartPar
nfreq{[}number{]}：频率采样点，默认值为200

\item {} 
\sphinxAtStartPar
wl\_max{[}number{]}：仿真所用波长最大值，默认值为1600nm

\item {} 
\sphinxAtStartPar
wl\_min{[}number{]} ：仿真所用波长最小值，默认值为1100nm

\item {} 
\sphinxAtStartPar
T\_z{[}number{]}：meep环境中监视器末端，默认值为1.9

\item {} 
\sphinxAtStartPar
resolution{[}number{]}：仿真分辨率，默认值为50（每单位um划分为50格）

\item {} 
\sphinxAtStartPar
auto\_shutoff\_min{[}number{]}：仿真截断时间，默认为1e\sphinxhyphen{}9s

\end{itemize}

\sphinxAtStartPar
代码区通过unity\_sim.set\_sim\_paras()函数定义全局变量，比如：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} 基础结构}
\PYG{n}{unit} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}6}
\PYG{n}{focal\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mi}{30} \PYG{o}{*} \PYG{n}{unit}                \PYG{c+c1}{\PYGZsh{} 聚焦距离}
\PYG{n}{lens\PYGZus{}radius} \PYG{o}{=} \PYG{l+m+mi}{15} \PYG{o}{*} \PYG{n}{unit}                 \PYG{c+c1}{\PYGZsh{} 透镜半径}
\PYG{n}{substrate\PYGZus{}thickness} \PYG{o}{=} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{unit}          \PYG{c+c1}{\PYGZsh{} SiO2衬底厚度}
\PYG{n}{period} \PYG{o}{=} \PYG{l+m+mf}{1.8} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{height} \PYG{o}{=} \PYG{l+m+mf}{2.5} \PYG{o}{*} \PYG{n}{unit}                     \PYG{c+c1}{\PYGZsh{} Si柱厚度}
\PYG{n}{wavelength} \PYG{o}{=} \PYG{l+m+mf}{3.8} \PYG{o}{*} \PYG{n}{unit}                 \PYG{c+c1}{\PYGZsh{} 工作波长}
\PYG{n}{T\PYGZus{}z} \PYG{o}{=} \PYG{n}{height} \PYG{o}{+} \PYG{l+m+mf}{1.5e\PYGZhy{}6}
\PYG{n}{wl\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mi}{5} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min} \PYG{o}{=} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{nfreq} \PYG{o}{=} \PYG{l+m+mi}{201}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{n}{T\PYGZus{}z}\PYG{p}{,}\PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{80}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{模型构建}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id4}}
\sphinxAtStartPar
微纳光学智能设计软件模型构建支持材料数据调用数据库中材料表中的特定材料、用户自定义折射率材料等，模型可构建方块、圆柱。
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{材料定义}
用户自定义材料折射率：

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{define\PYGZus{}material}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{n}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}定义材料的折射率}
\PYG{l+s+sd}{            name：类型：str，自定义材料名称}
\PYG{l+s+sd}{            n:材料的折射率}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} 材料定义}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{1.444}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{3.476}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
用户调用数据库\sphinxhyphen{}材料表中材料信息：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{nk\PYGZus{}material}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,}\PYG{n}{w}\PYG{p}{,}\PYG{n}{n}\PYG{p}{,}\PYG{n}{k}\PYG{p}{,}\PYG{n}{name}\PYG{p}{,}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    自定义n,k模型，传入材料}
\PYG{l+s+sd}{    par:}
\PYG{l+s+sd}{        w:波长}
\PYG{l+s+sd}{        n:折射率}
\PYG{l+s+sd}{        name:材料名称，str}
\PYG{l+s+sd}{        k:消光系数}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} 导入材料}
\PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3\PYGZus{}Al\PYGZus{}Rakic}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{data}\PYG{o}{=}\PYG{n}{device}\PYG{o}{.}\PYG{n}{get\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3\PYGZus{}Al\PYGZus{}Rakic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{nk\PYGZus{}material}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
其中name为材料表中存储的材料名（非中文）
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{1}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{模型定义}
用户建立方块模型：

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}block}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{} }
\PYG{l+s+sd}{    定义方块模型尺寸}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        size: (x\PYGZus{}span,y\PYGZus{}span,z\PYGZus{}span),沿x,y,z轴尺寸大小}
\PYG{l+s+sd}{        material\PYGZus{}name: 定义材料,类型：str}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        mesh\PYGZus{}order:}
\PYG{l+s+sd}{        color：定义模型材料颜色}
\PYG{l+s+sd}{        opacity:定义模型透明度}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
用户建立圆柱模型：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{radius}\PYG{p}{,} \PYG{n}{height}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{p}{,}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}定义圆柱模型尺寸}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        radius: 圆柱半径}
\PYG{l+s+sd}{        height：圆柱高度}
\PYG{l+s+sd}{        material\PYGZus{}name: 定义材料，类型：str}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        mesh\PYGZus{}order}
\PYG{l+s+sd}{        color：定义模型材料颜色}
\PYG{l+s+sd}{        opacity:定义模型透明度}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} 添加 SiO2 衬底}
\PYG{n}{unit} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}6}
\PYG{n}{period} \PYG{o}{=} \PYG{l+m+mf}{2.5} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{substrate\PYGZus{}thickness} \PYG{o}{=} \PYG{l+m+mi}{3} \PYG{o}{*} \PYG{n}{unit}  \PYG{c+c1}{\PYGZsh{} SiO2层衬底厚度}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{1.45}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{period}\PYG{p}{,} \PYG{n}{period}\PYG{p}{,} \PYG{n}{substrate\PYGZus{}thickness}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{substrate\PYGZus{}thickness}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
										\PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{substrate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Grey}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
软件代码兼容各个环境的API。


\subsection{源设置}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id5}}
\sphinxAtStartPar
微纳光学智能设计软件光源支持平面光源和高斯光源：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}source}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}定义光源}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        size: (x\PYGZus{}span,y\PYGZus{}span,z\PYGZus{}span),沿x,y,z轴尺寸大小}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        color：定义模型材料颜色，Red(default)}
\PYG{l+s+sd}{        opacity:定义模型透明度}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{        mode: TE(default),TM, LCP, RCP}
\PYG{l+s+sd}{        source\PYGZus{}type: 源类型   PlaneSource(dafault): 上方入射, 支持TE/TM/LCP/RCP}
\PYG{l+s+sd}{                        GaussSource: 下方入射, 支持 TE/TM}
\PYG{l+s+sd}{        w0: 束腰半径}
\PYG{l+s+sd}{        direction: 入射方向，forward/backward(default)}
\PYG{l+s+sd}{        injection: 入射轴，x/y/z(default)}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用左旋偏振光场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{unit} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}6}
\PYG{n}{period} \PYG{o}{=} \PYG{l+m+mf}{2.5} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{source\PYGZus{}z} \PYG{o}{=} \PYG{l+m+mi}{4} \PYG{o}{*} \PYG{n}{unit}
\PYG{n}{mode} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{LCP}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{period}\PYG{p}{,} \PYG{n}{period}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{n}{mode}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{监视器}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id6}}
\sphinxAtStartPar
微纳光学智能设计软件支持功率监视器及电场监视器：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}定义功率监视器区域}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        size: (x\PYGZus{}span,y\PYGZus{}span,z\PYGZus{}span),沿x,y,z轴尺寸大小}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        color：定义模型材料颜色，Red(default)}
\PYG{l+s+sd}{        opacity:定义模型透明度}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{    return:}
\PYG{l+s+sd}{        监视器的名称}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}

    \PYG{k}{def} \PYG{n+nf}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}定义电场监视器区域}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        size: (x\PYGZus{}span,y\PYGZus{}span,z\PYGZus{}span),沿x,y,z轴尺寸大小}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        color：定义模型材料颜色，Red(default)}
\PYG{l+s+sd}{        opacity:定义模型透明度}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{period}\PYG{p}{,} \PYG{n}{period}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZus{}monitor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
\sphinxstyleemphasis{备注: 用户必需定义center，size，name参数来建立监视器，否则无法加载}


\subsection{仿真区域}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id7}}
\sphinxAtStartPar
微纳光学智能设计软件使用unity\_sim.add\_sim\_area(center, size)定义模型的仿真区域:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{size}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{} 定义仿真区域}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        center:  (x,y,z),中心坐标}
\PYG{l+s+sd}{        size: (x\PYGZus{}span,y\PYGZus{}span,z\PYGZus{}span),沿x,y,z轴尺寸大小}
\PYG{l+s+sd}{    **kwargs：}
\PYG{l+s+sd}{        name:定义模型名称}
\PYG{l+s+sd}{        color：定义模型材料颜色，Orange(default)}
\PYG{l+s+sd}{        opacity:定义模型透明度, 0.4(default)}
\PYG{l+s+sd}{        line：True(default),是否线框}
\PYG{l+s+sd}{        boundary: 边界条件: Periodic(default)/ PML/ Symmetric\PYGZus{}TE/ Symmetric\PYGZus{}TM}
\PYG{l+s+sd}{                            或者输入 \PYGZob{}x\PYGZus{}bc, y\PYGZus{}bc, z\PYGZus{}bc\PYGZcb{}指定各自方向的边界条件, 必须输入x\PYGZus{}bc, y\PYGZus{}bc}
\PYG{l+s+sd}{        dimension: 仿真区域维度，2D/3D(default)}
\PYG{l+s+sd}{        sim\PYGZus{}time: 仿真时间，10000 * 1e\PYGZhy{}15 (default)}
\PYG{l+s+sd}{        mesh\PYGZus{}accuracy：网格精度，1\PYGZti{}9，2 (default)，数值越大，网格精度越高}
\PYG{l+s+sd}{        mesh\PYGZus{}geometry: 加网格的结构名称}
\PYG{l+s+sd}{        mesh\PYGZus{}dx:网格x方向的精度，若在该方向设定网格步长，需输入}
\PYG{l+s+sd}{        mesh\PYGZus{}dy:网格y方向的精度，若在该方向设定网格步长，需输入}
\PYG{l+s+sd}{        mesh\PYGZus{}dz:网格y方向的精度，若在该方向设定网格步长，需输入}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{period}\PYG{p}{,} \PYG{n}{period}\PYG{p}{,} \PYG{n}{z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{z\PYGZus{}cen}\PYG{p}{)}\PYG{p}{,} \PYG{n}{boundary}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Periodic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{mesh\PYGZus{}accuracy}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{sim\PYGZus{}time}\PYG{o}{=}\PYG{l+m+mf}{3000e\PYGZhy{}15}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{仿真运行}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id8}}
\sphinxAtStartPar
微纳光学智能设计软件使用unity\_sim.run()仿真运行：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{run}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,}  \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}仿真运行}
\PYG{l+s+sd}{    **kwargs:}
\PYG{l+s+sd}{        name:后台保存文件.fsp名称}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{save\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{chiral\PYGZus{}LCP}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{save\PYGZus{}name}\PYG{o}{=}\PYG{n}{save\PYGZus{}name}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{结果提取}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id9}}
\sphinxAtStartPar
微纳光学智能设计软件可提取监视器结果：
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
提取功率监视器：

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}从功率监视器提取数据}
\PYG{l+s+sd}{    parameter:}
\PYG{l+s+sd}{        name:  监视器，add\PYGZus{}monitor()中的名字}
\PYG{l+s+sd}{    return：}
\PYG{l+s+sd}{        power:从监视器提取的数据T/R}
\PYG{l+s+sd}{        wl: 波长， 单位为设定的unit}
\PYG{l+s+sd}{        f:频率点}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{1}
\item {} 
\sphinxAtStartPar
提取电场监视器：

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}result\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}从电场监视器提取数据}
\PYG{l+s+sd}{    return：}
\PYG{l+s+sd}{        Ex:电场x的分量}
\PYG{l+s+sd}{        Ey:电场y的分量}
\PYG{l+s+sd}{        Ez:电场z的分量}
\PYG{l+s+sd}{        f: 频率，单位 Hz}
\PYG{l+s+sd}{        wl: 波长，单位 m}
\PYG{l+s+sd}{        x, y, z: 电场监视器范围，单位 m}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}


\subsection{性能图保存}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id10}}
\sphinxAtStartPar
微纳光学智能设计软件支持图片保存：数据处理后绘制图片可保存到页面性能图中，后续也可通过数据库\sphinxhyphen{}器件库查看，使用
device.save\_fig(name, file\_path, file\_data\_path):
\begin{itemize}
\item {} 
\sphinxAtStartPar
name{[}string{]}：图片名称

\item {} 
\sphinxAtStartPar
file\_path{[}string{]}：图片保存名，例如picture.png

\item {} 
\sphinxAtStartPar
file\_data\_path{[}string{]}：数据保存名，例如data.txt

\end{itemize}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}

\PYG{c+c1}{\PYGZsh{} 结果处理 \PYGZhy{} 透射率}
\PYG{n}{wl} \PYG{o}{=} \PYG{n}{result\PYGZus{}RCP}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wl}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} 单位： um}
\PYG{n}{T\PYGZus{}LCP} \PYG{o}{=} \PYG{n}{result\PYGZus{}LCP}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{T\PYGZus{}RCP} \PYG{o}{=} \PYG{n}{result\PYGZus{}RCP}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{T\PYGZus{}LCP}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZus{}LCP}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{T\PYGZus{}RCP}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZus{}RCP}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{T\PYGZus{}LCP}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{T\PYGZus{}RCP}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CD}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chiral\PYGZus{}CD.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{LCP\PYGZus{}power} \PYG{o}{=} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{T\PYGZus{}LCP}\PYG{p}{)}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LCP\PYGZus{}power.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{LCP\PYGZus{}power}\PYG{p}{)}  
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chiral\PYGZus{}CD}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{chiral\PYGZus{}CD.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}data\PYGZus{}path} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{LCP\PYGZus{}power.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
性能图展示后可通过导出数据按钮下载file\_data\_path中存储的数据文件。


\subsection{退出仿真}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u4eff_u771f/_u4eff_u771f:id11}}
\sphinxAtStartPar
微纳光学智能设计软件退出当前仿真进程可点击代码区域右侧暂停按钮强退出，或者在代码区使用quit()函数：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{quit}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    关闭 lumerical/cst/meep}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
\end{sphinxVerbatim}

\sphinxAtStartPar
使用场景：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{quit}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxstepscope


\section{教程/微纳结构}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:id1}}\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784::doc}}

\subsection{Meta结构建模仿真}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:meta}}
\sphinxAtStartPar
微纳光学智能设计软件支持meep/Lumerical/CST环境建模仿真，并统一接口代码让用户使用，本节给出超表面单元结构的建模示例，运行完成后软件会生成光谱图像。


\sphinxAtStartPar
\sphinxincludegraphics{{model}.jpg}





\sphinxAtStartPar
这里给出的是Meta结构建模仿真的统一代码：


\subsubsection{1. Lumerical 环境}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:lumerical}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}lum环境\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq}\PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}\PYG{p}{,}\PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}添加结构}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{1.5}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{3.4}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{block}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}
\PYG{n}{cylinder}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n}{radius}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{height}\PYG{o}{=} \PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}添加源，监视器}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}运行}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{wl} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wl}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{result1}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{}提取电场}
\PYG{n}{E\PYGZus{}total} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ex}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ey}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ez}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{E\PYGZus{}total}\PYG{p}{:}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{E} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{E}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lower}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{E}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}提取光谱图}
\PYG{n}{wls} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Rs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Ts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nfreq}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wls} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{wl}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Rs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Rs}\PYG{p}{,} \PYG{n}{R}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Ts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Ts}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wls} \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Rs}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{}}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Rs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}}\PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
示例运行后的结果展示：


\sphinxAtStartPar
\sphinxincludegraphics{{lum}.jpg}






\subsubsection{2. Meep 环境}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:meep}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mi}{1}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq} \PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{n}{fmax} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{wl\PYGZus{}min}
\PYG{n}{fmin} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{wl\PYGZus{}max}
\PYG{n}{fcen} \PYG{o}{=} \PYG{p}{(}\PYG{n}{fmin} \PYG{o}{+} \PYG{n}{fmax}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{fmax} \PYG{o}{\PYGZhy{}} \PYG{n}{fmin}
\PYG{n}{dpml} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{fcen}\PYG{o}{/} \PYG{l+m+mi}{2}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}\PYG{p}{,}\PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}添加结构}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{1.5}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{3.4}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{block}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}
\PYG{n}{cylinder}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n}{radius}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{height}\PYG{o}{=} \PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}添加源，监视器}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{+} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{dpml}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}\PYG{n}{geometry}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{inc} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}第一次运行}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{inc}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}flux}\PYG{p}{(}\PYG{n}{R}\PYG{p}{)}

\PYG{n}{input\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}\PYG{n}{geometry}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{E\PYGZus{}field} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{load\PYGZus{}minus\PYGZus{}flux\PYGZus{}data}\PYG{p}{(}\PYG{n}{R}\PYG{p}{,}\PYG{n}{result1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}第二次运行}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{T}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{R}\PYG{p}{)}


\PYG{n}{flux\PYGZus{}freqs} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{tran\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{refl\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result1}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}提取电场}
\PYG{n}{E\PYGZus{}total} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ex}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ey}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ez}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n}{E\PYGZus{}total}\PYG{p}{:}
    \PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{E} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{flipud}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{E}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lower}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZus{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{E}\PYG{p}{)}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meta\PYGZus{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{i}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}提取光谱图}
\PYG{n}{wls} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Rs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Ts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nfreq}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wls} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{flux\PYGZus{}freqs}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Rs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Rs}\PYG{p}{,} \PYG{n}{refl\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n}{input\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Ts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Ts}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{tran\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n}{input\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wls} \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Rs}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{}}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Rs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meta\PYGZus{}model.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meta\PYGZus{}model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meta\PYGZus{}model.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
示例运行后的结果展示：


\sphinxAtStartPar
\sphinxincludegraphics{{meep}.jpg}






\subsubsection{3. RCWA 环境}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:rcwa}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{l+s+sd}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+sd}{TORCWA unity AOM，单位均为 nm}
\PYG{l+s+sd}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Import}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{torch}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{torcwa}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 创建预览要素}
\PYG{n}{tree} \PYG{o}{=} \PYG{n}{ModelTree}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step1：参数设置}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} Hardware}
\PYG{c+c1}{\PYGZsh{} If GPU support TF32 tensor core, the matmul operation is faster than FP32 but with less precision.}
\PYG{c+c1}{\PYGZsh{} If you need accurate operation, you have to disable the flag below.}
\PYG{n}{torch}\PYG{o}{.}\PYG{n}{backends}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{matmul}\PYG{o}{.}\PYG{n}{allow\PYGZus{}tf32} \PYG{o}{=} \PYG{k+kc}{True}
\PYG{n}{sim\PYGZus{}dtype} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{complex64}
\PYG{n}{geo\PYGZus{}dtype} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}
\PYG{n}{device0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{device}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cuda}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mf}{1e3}   \PYG{c+c1}{\PYGZsh{} 单位：nm}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq}\PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{c+c1}{\PYGZsh{} Simulation environment}
\PYG{c+c1}{\PYGZsh{} light}
\PYG{n}{inc\PYGZus{}ang} \PYG{o}{=} \PYG{l+m+mf}{0.}\PYG{o}{*}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{180}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} radian}
\PYG{n}{azi\PYGZus{}ang} \PYG{o}{=} \PYG{l+m+mf}{0.}\PYG{o}{*}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{180}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} radian}
\PYG{c+c1}{\PYGZsh{} material}
\PYG{n}{substrate\PYGZus{}eps} \PYG{o}{=} \PYG{l+m+mf}{1.5}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{silicon\PYGZus{}eps} \PYG{o}{=}\PYG{l+m+mf}{3.4}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{c+c1}{\PYGZsh{} geometry}
\PYG{n}{L} \PYG{o}{=} \PYG{p}{[}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{]}            \PYG{c+c1}{\PYGZsh{} nm / nm}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{dtype} \PYG{o}{=} \PYG{n}{geo\PYGZus{}dtype}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{device} \PYG{o}{=} \PYG{n}{device0}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{Lx} \PYG{o}{=} \PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{Ly} \PYG{o}{=} \PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{nx} \PYG{o}{=} \PYG{l+m+mi}{1300}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{ny} \PYG{o}{=} \PYG{l+m+mi}{1300}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{edge\PYGZus{}sharpness} \PYG{o}{=} \PYG{l+m+mf}{1000.}
\PYG{n}{z} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2000}\PYG{p}{,}\PYG{l+m+mi}{2000}\PYG{p}{,}\PYG{l+m+mi}{1500}\PYG{p}{,}\PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}
\PYG{n}{x\PYGZus{}axis} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{x}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{y\PYGZus{}axis} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{y}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{z\PYGZus{}axis} \PYG{o}{=} \PYG{n}{z}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} layers}
\PYG{n}{layer0\PYGZus{}geometry} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{circle}\PYG{p}{(}\PYG{n}{R}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,}\PYG{n}{Cx}\PYG{o}{=}\PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{2.}\PYG{p}{,}\PYG{n}{Cy}\PYG{o}{=}\PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{2.}\PYG{p}{)}
\PYG{n}{layer0\PYGZus{}thickness} \PYG{o}{=} \PYG{n}{c\PYGZus{}h}
\PYG{c+c1}{\PYGZsh{} Generate and perform simulation}
\PYG{n}{order\PYGZus{}N} \PYG{o}{=} \PYG{l+m+mi}{7}
\PYG{n}{order} \PYG{o}{=} \PYG{p}{[}\PYG{n}{order\PYGZus{}N}\PYG{p}{,}\PYG{n}{order\PYGZus{}N}\PYG{p}{]}

\PYG{n}{lamb0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{dtype}\PYG{o}{=}\PYG{n}{geo\PYGZus{}dtype}\PYG{p}{,}\PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                     step2:建立仿真区域}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}simarea}\PYG{p}{(}\PYG{n}{freq}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 添加rcwa仿真区域：长宽为L}
    \PYG{n}{sim} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa}\PYG{p}{(}\PYG{n}{freq}\PYG{o}{=}\PYG{n}{freq}\PYG{p}{,} \PYG{n}{order}\PYG{o}{=}\PYG{n}{order}\PYG{p}{,} \PYG{n}{L}\PYG{o}{=}\PYG{n}{L}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{sim\PYGZus{}dtype}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{sim}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{opacity}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sim Area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step3：添加光源}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 添加光源，入射角度，相位角,位置默认为第一层结构位置处入射，长宽为L}
    \PYG{n}{source} \PYG{o}{=} \PYG{n}{sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}incident\PYGZus{}angle}\PYG{p}{(}\PYG{n}{inc\PYGZus{}ang}\PYG{o}{=}\PYG{n}{inc\PYGZus{}ang}\PYG{p}{,} \PYG{n}{azi\PYGZus{}ang}\PYG{o}{=}\PYG{n}{azi\PYGZus{}ang}\PYG{p}{)} 
    \PYG{k}{return} \PYG{n}{source}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{line}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{source}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{wl\PYGZus{}min} \PYG{k}{if} \PYG{n}{source\PYGZus{}z} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Arrow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Light Source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step4：添加仿真模型结构}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}添加第一层和最后一层}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}first\PYGZus{}last\PYGZus{}layer}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{eps\PYGZus{}in}\PYG{p}{,}\PYG{n}{eps\PYGZus{}out}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 创建最顶层block，厚度为半无限，材料介电常数为eps\PYGZus{}in，长宽为L}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}input\PYGZus{}layer}\PYG{p}{(}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps\PYGZus{}in}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} 创建最底层block，厚度为半无限，材料介电常数为eps\PYGZus{}out，长宽为L}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}output\PYGZus{}layer}\PYG{p}{(}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps\PYGZus{}out}\PYG{p}{)}   
    \PYG{k}{return}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Block}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 添加中间层}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}cir}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{thickness}\PYG{p}{,}\PYG{n}{eps}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 创建圆柱，厚度为layer0\PYGZus{}thickness=220，半径为：R=206,X中心左标：Cx=L[0]/2.,Y中心坐标：Cy=L[1]/2.单位为nm,材料介电常数为：layer0\PYGZus{}eps}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}layer}\PYG{p}{(}\PYG{n}{thickness}\PYG{o}{=}\PYG{n}{thickness}\PYG{p}{,} \PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps}\PYG{p}{)}
    \PYG{k}{return}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{c\PYGZus{}r}\PYG{p}{,}\PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step5： 添加监视器,位置由port决定}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{direction}\PYG{p}{,}\PYG{n}{port}\PYG{p}{,}\PYG{n}{polar}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{monitor} \PYG{o}{=} \PYG{n}{sim}\PYG{o}{.}\PYG{n}{S\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{orders}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{direction}\PYG{o}{=}\PYG{n}{direction}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{n}{port}\PYG{p}{,} \PYG{n}{polarization}\PYG{o}{=}\PYG{n}{polar}\PYG{p}{,}
                            \PYG{n}{ref\PYGZus{}order}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}   
    \PYG{k}{return} \PYG{n}{monitor}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{line}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Monitor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step6： 仿真运行}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{run}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{solve\PYGZus{}global\PYGZus{}smatrix}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 运行}
    \PYG{k}{return}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step7：多个点仿真运行，输出光谱图数据}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{t} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{r} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{a} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{lamb0\PYGZus{}ind} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{lamb0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{lamb0\PYGZus{}now} \PYG{o}{=} \PYG{n}{lamb0}\PYG{p}{[}\PYG{n}{lamb0\PYGZus{}ind}\PYG{p}{]}
    \PYG{n}{sim} \PYG{o}{=} \PYG{n}{add\PYGZus{}simarea}\PYG{p}{(}\PYG{n}{freq}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{lamb0\PYGZus{}now}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}first\PYGZus{}last\PYGZus{}layer}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{eps\PYGZus{}in}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{eps\PYGZus{}out}\PYG{o}{=}\PYG{n}{substrate\PYGZus{}eps}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}
    \PYG{n}{layer0\PYGZus{}eps} \PYG{o}{=} \PYG{n}{layer0\PYGZus{}geometry} \PYG{o}{*} \PYG{n}{silicon\PYGZus{}eps} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mf}{1.} \PYG{o}{\PYGZhy{}} \PYG{n}{layer0\PYGZus{}geometry}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}cir}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{thickness}\PYG{o}{=}\PYG{n}{layer0\PYGZus{}thickness}\PYG{p}{,}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{layer0\PYGZus{}eps}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} run(sim)}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{solve\PYGZus{}global\PYGZus{}smatrix}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ss\PYGZus{}t} \PYG{o}{=} \PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,} \PYG{n}{direction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{forward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmission}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{polar}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ss\PYGZus{}r} \PYG{o}{=} \PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{direction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{forward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{polar}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{t}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{ss\PYGZus{}t}\PYG{p}{)}
    \PYG{n}{r}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{ss\PYGZus{}r}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{lamb0\PYGZus{}ind}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step8：处理数据}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{n}{r}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{wl} \PYG{o}{=} \PYG{n}{lamb0}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{)}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wl}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{R}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{T}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{R}\PYG{o}{\PYGZhy{}}\PYG{n}{T}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{data}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{} 需要保存到本地数据txt文件}

\PYG{c+c1}{\PYGZsh{} View spectrum}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{T}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmission}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{R}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{R}\PYG{o}{\PYGZhy{}}\PYG{n}{T}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spectrum (order: }\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{+}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{order\PYGZus{}N}\PYG{p}{)}\PYG{o}{+}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Wavelength (nm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}   需要展示的数据图}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\end{sphinxVerbatim}

\sphinxAtStartPar
由于rcwa环境正在开发中，示例中给出的是部分统一接口
示例运行后的结果展示：


\sphinxAtStartPar
\sphinxincludegraphics{{rcwa}.png}






\subsubsection{4. CST环境}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:cst}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}cst环境\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{unit} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}unit}\PYG{p}{(}\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq}\PYG{o}{=}\PYG{l+m+mi}{51}
\PYG{n}{save\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{circle\PYGZus{}cst}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,} \PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,} \PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}\PYG{p}{,} \PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,} \PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}添加结构}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mf}{3.4}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{air}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{block} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}
\PYG{n}{cylinder} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n}{radius}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{height}\PYG{o}{=} \PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}

\PYG{c+c1}{\PYGZsh{} 添加空气块}
\PYG{n}{air} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{/}\PYG{l+m+mi}{4} \PYG{o}{\PYGZhy{}} \PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
\PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{air}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{combine\PYGZus{}models}\PYG{p}{(}\PYG{n}{air}\PYG{p}{,} \PYG{n}{cylinder}\PYG{p}{,} \PYG{n}{boolean\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{insert}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}添加源，监视器}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}运行\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst 正在运行，请等待............}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{save\PYGZus{}name}\PYG{o}{=}\PYG{n}{save\PYGZus{}name}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}提取数据\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{wl} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wl}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{result1}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}提取光谱图}
\PYG{n}{wls} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Rs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Ts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wls} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{wl}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Rs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Rs}\PYG{p}{,} \PYG{n}{R}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Ts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Ts}\PYG{p}{,} \PYG{n}{T}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wls} \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Rs}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{}}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Rs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}}\PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}meta\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum} \PYG{o}{=} \PYG{n}{wls}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Rs\PYGZus{}lum} \PYG{o}{=} \PYG{n}{Rs}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Ts\PYGZus{}lum} \PYG{o}{=} \PYG{n}{Ts}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
示例运行后的结果展示：


\sphinxAtStartPar
\sphinxincludegraphics{{cst}.png}






\subsubsection{5. 四环境合并示例}
\label{\detokenize{_u8f6f_u4ef6API_u63a5_u53e3/_u5fae_u7eb3_u7ed3_u6784/_u5fae_u7eb3_u7ed3_u6784:id2}}
\sphinxAtStartPar
验证微纳光学智能设计软件四个环境下可以逐步仿真，联合调动，这里给出四环境合并示例代码，四个环境结果会进行对比展示：

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mf}{1e\PYGZhy{}6}   \PYG{c+c1}{\PYGZsh{} 单位：m}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq}\PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}\PYG{p}{,}\PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}添加结构}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{1.5}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{3.4}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{block}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}
\PYG{n}{cylinder}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n}{radius}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{height}\PYG{o}{=} \PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}添加源，监视器}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}运行}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum正在运行，请等待............}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{name}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{wl} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wl}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{result1}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}提取光谱图}
\PYG{n}{wls} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Rs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Ts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nfreq}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wls} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{wl}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Rs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Rs}\PYG{p}{,} \PYG{n}{R}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Ts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Ts}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wls} \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Rs}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{}}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Rs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}}\PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum\PYGZus{}meta\PYGZus{}model}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum} \PYG{o}{=} \PYG{n}{wls}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Rs\PYGZus{}lum} \PYG{o}{=} \PYG{n}{Rs}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Ts\PYGZus{}lum} \PYG{o}{=} \PYG{n}{Ts}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lum仿真完毕！！！！！！！！}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mi}{1}          \PYG{c+c1}{\PYGZsh{} 单位：um}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq} \PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{n}{fmax} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{wl\PYGZus{}min}
\PYG{n}{fmin} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{wl\PYGZus{}max}
\PYG{n}{fcen} \PYG{o}{=} \PYG{p}{(}\PYG{n}{fmin} \PYG{o}{+} \PYG{n}{fmax}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}
\PYG{n}{df} \PYG{o}{=} \PYG{n}{fmax} \PYG{o}{\PYGZhy{}} \PYG{n}{fmin}
\PYG{n}{dpml} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{fcen}\PYG{o}{/} \PYG{l+m+mi}{2}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}sim\PYGZus{}paras}\PYG{p}{(}\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}\PYG{p}{,}\PYG{n}{nfreq}\PYG{o}{=}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}添加结构}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{1.5}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{define\PYGZus{}material}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+m+mf}{3.4}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 定义材料}
\PYG{n}{block}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}block}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SiO2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}
\PYG{n}{cylinder}\PYG{o}{=}\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}cylinder}\PYG{p}{(}\PYG{n}{radius}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{material\PYGZus{}name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Si}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{height}\PYG{o}{=} \PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} 添加方块}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}添加源，监视器}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{+} \PYG{l+m+mi}{2} \PYG{o}{*} \PYG{n}{dpml}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}\PYG{n}{geometry}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{inc} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}第一次运行}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep正在运行，请等待............}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{inc}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}flux}\PYG{p}{(}\PYG{n}{R}\PYG{p}{)}

\PYG{n}{input\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{reset}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}sim\PYGZus{}area}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,}\PYG{n}{geometry}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{E\PYGZus{}field} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}monitor\PYGZus{}field}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,}\PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{load\PYGZus{}minus\PYGZus{}flux\PYGZus{}data}\PYG{p}{(}\PYG{n}{R}\PYG{p}{,}\PYG{n}{result1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}第二次运行}
\PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{result} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{T}\PYG{p}{)}
\PYG{n}{result1} \PYG{o}{=} \PYG{n}{unity\PYGZus{}sim}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{R}\PYG{p}{)}


\PYG{n}{flux\PYGZus{}freqs} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{tran\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{refl\PYGZus{}flux} \PYG{o}{=} \PYG{n}{result1}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{power}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}提取光谱图}
\PYG{n}{wls} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Rs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{Ts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nfreq}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wls} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{flux\PYGZus{}freqs}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Rs} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Rs}\PYG{p}{,} \PYG{n}{refl\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n}{input\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{Ts} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{Ts}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{tran\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{/} \PYG{n}{input\PYGZus{}flux}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wls} \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Rs}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}  \PYG{c+c1}{\PYGZsh{}}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{}}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Rs}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{Rs} \PYG{o}{\PYGZhy{}} \PYG{n}{Ts}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep\PYGZus{}meta\PYGZus{}model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep\PYGZus{}meta\PYGZus{}model.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep\PYGZus{}data\PYGZus{}meta\PYGZus{}model.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{wls\PYGZus{}meep} \PYG{o}{=} \PYG{n}{wls}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Rs\PYGZus{}meep} \PYG{o}{=} \PYG{n}{Rs}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Ts\PYGZus{}meep} \PYG{o}{=} \PYG{n}{Ts}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{meep仿真完毕！！！！！！！！！！！！}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Import}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{torch}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pyplot} \PYG{k}{as} \PYG{n}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{torcwa}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 创建预览要素}
\PYG{n}{tree} \PYG{o}{=} \PYG{n}{ModelTree}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step1：参数设置}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} Hardware}
\PYG{c+c1}{\PYGZsh{} If GPU support TF32 tensor core, the matmul operation is faster than FP32 but with less precision.}
\PYG{c+c1}{\PYGZsh{} If you need accurate operation, you have to disable the flag below.}
\PYG{n}{torch}\PYG{o}{.}\PYG{n}{backends}\PYG{o}{.}\PYG{n}{cuda}\PYG{o}{.}\PYG{n}{matmul}\PYG{o}{.}\PYG{n}{allow\PYGZus{}tf32} \PYG{o}{=} \PYG{k+kc}{True}
\PYG{n}{sim\PYGZus{}dtype} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{complex64}
\PYG{n}{geo\PYGZus{}dtype} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{float32}
\PYG{n}{device0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{device}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cuda}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{unit}\PYG{o}{=}\PYG{l+m+mf}{1e3}   \PYG{c+c1}{\PYGZsh{} 单位：nm}
\PYG{n}{dp}\PYG{o}{=}\PYG{l+m+mf}{0.66}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{dsub}\PYG{o}{=}\PYG{l+m+mf}{2.5}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}r}\PYG{o}{=}\PYG{l+m+mf}{0.206}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{c\PYGZus{}h}\PYG{o}{=}\PYG{l+m+mf}{0.22}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{source\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{T\PYGZus{}z}\PYG{o}{=}\PYG{l+m+mf}{1.9}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}max}\PYG{o}{=}\PYG{l+m+mf}{1.6}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{wl\PYGZus{}min}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{unit}
\PYG{n}{nfreq}\PYG{o}{=}\PYG{l+m+mi}{200}

\PYG{c+c1}{\PYGZsh{} Simulation environment}
\PYG{c+c1}{\PYGZsh{} light}
\PYG{n}{inc\PYGZus{}ang} \PYG{o}{=} \PYG{l+m+mf}{0.}\PYG{o}{*}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{180}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} radian}
\PYG{n}{azi\PYGZus{}ang} \PYG{o}{=} \PYG{l+m+mf}{0.}\PYG{o}{*}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{180}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{} radian}
\PYG{c+c1}{\PYGZsh{} material}
\PYG{n}{substrate\PYGZus{}eps} \PYG{o}{=} \PYG{l+m+mf}{1.5}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{silicon\PYGZus{}eps} \PYG{o}{=}\PYG{l+m+mf}{3.4}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{c+c1}{\PYGZsh{} geometry}
\PYG{n}{L} \PYG{o}{=} \PYG{p}{[}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{]}            \PYG{c+c1}{\PYGZsh{} nm / nm}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{dtype} \PYG{o}{=} \PYG{n}{geo\PYGZus{}dtype}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{device} \PYG{o}{=} \PYG{n}{device0}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{Lx} \PYG{o}{=} \PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{Ly} \PYG{o}{=} \PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{nx} \PYG{o}{=} \PYG{l+m+mi}{1300}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{ny} \PYG{o}{=} \PYG{l+m+mi}{1300}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{edge\PYGZus{}sharpness} \PYG{o}{=} \PYG{l+m+mf}{1000.}
\PYG{n}{z} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2000}\PYG{p}{,}\PYG{l+m+mi}{2000}\PYG{p}{,}\PYG{l+m+mi}{1500}\PYG{p}{,}\PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}
\PYG{n}{x\PYGZus{}axis} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{x}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{y\PYGZus{}axis} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{y}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{z\PYGZus{}axis} \PYG{o}{=} \PYG{n}{z}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} layers}
\PYG{n}{layer0\PYGZus{}geometry} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa\PYGZus{}geo}\PYG{o}{.}\PYG{n}{circle}\PYG{p}{(}\PYG{n}{R}\PYG{o}{=}\PYG{n}{c\PYGZus{}r}\PYG{p}{,}\PYG{n}{Cx}\PYG{o}{=}\PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{2.}\PYG{p}{,}\PYG{n}{Cy}\PYG{o}{=}\PYG{n}{L}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{2.}\PYG{p}{)}
\PYG{n}{layer0\PYGZus{}thickness} \PYG{o}{=} \PYG{n}{c\PYGZus{}h}
\PYG{c+c1}{\PYGZsh{} Generate and perform simulation}
\PYG{n}{order\PYGZus{}N} \PYG{o}{=} \PYG{l+m+mi}{7}
\PYG{n}{order} \PYG{o}{=} \PYG{p}{[}\PYG{n}{order\PYGZus{}N}\PYG{p}{,}\PYG{n}{order\PYGZus{}N}\PYG{p}{]}

\PYG{n}{lamb0} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,}\PYG{n}{wl\PYGZus{}max}\PYG{p}{,}\PYG{n}{nfreq}\PYG{p}{,}\PYG{n}{dtype}\PYG{o}{=}\PYG{n}{geo\PYGZus{}dtype}\PYG{p}{,}\PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                     step2:建立仿真区域}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}simarea}\PYG{p}{(}\PYG{n}{freq}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 添加rcwa仿真区域：长宽为L}
    \PYG{n}{sim} \PYG{o}{=} \PYG{n}{torcwa}\PYG{o}{.}\PYG{n}{rcwa}\PYG{p}{(}\PYG{n}{freq}\PYG{o}{=}\PYG{n}{freq}\PYG{p}{,} \PYG{n}{order}\PYG{o}{=}\PYG{n}{order}\PYG{p}{,} \PYG{n}{L}\PYG{o}{=}\PYG{n}{L}\PYG{p}{,} \PYG{n}{dtype}\PYG{o}{=}\PYG{n}{sim\PYGZus{}dtype}\PYG{p}{,} \PYG{n}{device}\PYG{o}{=}\PYG{n}{device0}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{sim}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{opacity}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sim Area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step3：添加光源}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 添加光源，入射角度，相位角,位置默认为第一层结构位置处入射，长宽为L}
    \PYG{n}{source} \PYG{o}{=} \PYG{n}{sim}\PYG{o}{.}\PYG{n}{set\PYGZus{}incident\PYGZus{}angle}\PYG{p}{(}\PYG{n}{inc\PYGZus{}ang}\PYG{o}{=}\PYG{n}{inc\PYGZus{}ang}\PYG{p}{,} \PYG{n}{azi\PYGZus{}ang}\PYG{o}{=}\PYG{n}{azi\PYGZus{}ang}\PYG{p}{)} 
    \PYG{k}{return} \PYG{n}{source}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{line}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{source}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{wl\PYGZus{}min} \PYG{k}{if} \PYG{n}{source\PYGZus{}z} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Arrow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Light Source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step4：添加仿真模型结构}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}添加第一层和最后一层}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}first\PYGZus{}last\PYGZus{}layer}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{eps\PYGZus{}in}\PYG{p}{,}\PYG{n}{eps\PYGZus{}out}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 创建最顶层block，厚度为半无限，材料介电常数为eps\PYGZus{}in，长宽为L}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}input\PYGZus{}layer}\PYG{p}{(}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps\PYGZus{}in}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} 创建最底层block，厚度为半无限，材料介电常数为eps\PYGZus{}out，长宽为L}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}output\PYGZus{}layer}\PYG{p}{(}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps\PYGZus{}out}\PYG{p}{)}   
    \PYG{k}{return}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Block}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} 添加中间层}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}cir}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{thickness}\PYG{p}{,}\PYG{n}{eps}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} 创建圆柱，厚度为layer0\PYGZus{}thickness=220，半径为：R=206,X中心左标：Cx=L[0]/2.,Y中心坐标：Cy=L[1]/2.单位为nm,材料介电常数为：layer0\PYGZus{}eps}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{add\PYGZus{}layer}\PYG{p}{(}\PYG{n}{thickness}\PYG{o}{=}\PYG{n}{thickness}\PYG{p}{,} \PYG{n}{eps}\PYG{o}{=}\PYG{n}{eps}\PYG{p}{)}
    \PYG{k}{return}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{c\PYGZus{}r}\PYG{p}{,}\PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step5： 添加监视器,位置由port决定}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{direction}\PYG{p}{,}\PYG{n}{port}\PYG{p}{,}\PYG{n}{polar}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{monitor} \PYG{o}{=} \PYG{n}{sim}\PYG{o}{.}\PYG{n}{S\PYGZus{}parameters}\PYG{p}{(}\PYG{n}{orders}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{direction}\PYG{o}{=}\PYG{n}{direction}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{n}{port}\PYG{p}{,} \PYG{n}{polarization}\PYG{o}{=}\PYG{n}{polar}\PYG{p}{,}
                            \PYG{n}{ref\PYGZus{}order}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}   
    \PYG{k}{return} \PYG{n}{monitor}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{line}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Monitor}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step6： 仿真运行}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{k}{def} \PYG{n+nf}{run}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{solve\PYGZus{}global\PYGZus{}smatrix}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} 运行}
    \PYG{k}{return}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa正在运行，请等待............}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step7：多个点仿真运行，输出光谱图数据}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{t} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{r} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{a} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{lamb0\PYGZus{}ind} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{lamb0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{lamb0\PYGZus{}now} \PYG{o}{=} \PYG{n}{lamb0}\PYG{p}{[}\PYG{n}{lamb0\PYGZus{}ind}\PYG{p}{]}
    \PYG{n}{sim} \PYG{o}{=} \PYG{n}{add\PYGZus{}simarea}\PYG{p}{(}\PYG{n}{freq}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{/}\PYG{n}{lamb0\PYGZus{}now}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}first\PYGZus{}last\PYGZus{}layer}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{eps\PYGZus{}in}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{eps\PYGZus{}out}\PYG{o}{=}\PYG{n}{substrate\PYGZus{}eps}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}source}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}
    \PYG{n}{layer0\PYGZus{}eps} \PYG{o}{=} \PYG{n}{layer0\PYGZus{}geometry} \PYG{o}{*} \PYG{n}{silicon\PYGZus{}eps} \PYG{o}{+} \PYG{p}{(}\PYG{l+m+mf}{1.} \PYG{o}{\PYGZhy{}} \PYG{n}{layer0\PYGZus{}geometry}\PYG{p}{)}
    \PYG{n}{add\PYGZus{}cir}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{thickness}\PYG{o}{=}\PYG{n}{layer0\PYGZus{}thickness}\PYG{p}{,}\PYG{n}{eps}\PYG{o}{=}\PYG{n}{layer0\PYGZus{}eps}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} run(sim)}
    \PYG{n}{sim}\PYG{o}{.}\PYG{n}{solve\PYGZus{}global\PYGZus{}smatrix}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ss\PYGZus{}t} \PYG{o}{=} \PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,} \PYG{n}{direction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{forward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmission}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{polar}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ss\PYGZus{}r} \PYG{o}{=} \PYG{n}{add\PYGZus{}monitor}\PYG{p}{(}\PYG{n}{sim}\PYG{o}{=}\PYG{n}{sim}\PYG{p}{,}\PYG{n}{direction}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{forward}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{port}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{polar}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{t}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{ss\PYGZus{}t}\PYG{p}{)}
    \PYG{n}{r}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{ss\PYGZus{}r}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{lamb0\PYGZus{}ind}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}                      step8：处理数据}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{torch}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{torch}\PYG{o}{.}\PYG{n}{cat}\PYG{p}{(}\PYG{n}{r}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}
\PYG{n}{wl} \PYG{o}{=} \PYG{n}{lamb0}\PYG{o}{.}\PYG{n}{cpu}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{)}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{wl}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{R}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{T}
\PYG{n}{data}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{R}\PYG{o}{\PYGZhy{}}\PYG{n}{T}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{savetxt}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{data}\PYG{p}{)}    \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{} 需要保存到本地数据txt文件}

\PYG{c+c1}{\PYGZsh{} View spectrum}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{T}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmission}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{R}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{R}\PYG{o}{\PYGZhy{}}\PYG{n}{T}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Spectrum (order: }\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{+}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{order\PYGZus{}N}\PYG{p}{)}\PYG{o}{+}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Wavelength (μm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}   需要展示的数据图}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}data\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa\PYGZus{}unity\PYGZus{}AOM.txt}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{wls\PYGZus{}rcwa} \PYG{o}{=} \PYG{n}{wl}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Rs\PYGZus{}rcwa} \PYG{o}{=} \PYG{n}{R}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{unityCode}\PYG{o}{.}\PYG{n}{save\PYGZus{}data}\PYG{p}{(}\PYG{n}{Ts\PYGZus{}rcwa} \PYG{o}{=} \PYG{n}{T}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rcwa仿真完毕！！！！！！！！！！}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{sim\PYGZus{}start}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{k+kn}{import} \PYG{n+nn}{cst}
\PYG{k+kn}{from} \PYG{n+nn}{cst} \PYG{k+kn}{import} \PYG{n}{interface}\PYG{p}{,} \PYG{n}{results}
\PYG{k+kn}{from} \PYG{n+nn}{cst}\PYG{n+nn}{.}\PYG{n+nn}{interface} \PYG{k+kn}{import} \PYG{n}{Project}

\PYG{k+kn}{import} \PYG{n+nn}{time}
\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{n}{os}\PYG{o}{.}\PYG{n}{environ}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KMP\PYGZus{}DUPLICATE\PYGZus{}LIB\PYGZus{}OK}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{TRUE}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}


\PYG{c+c1}{\PYGZsh{} step 0}
\PYG{k}{def} \PYG{n+nf}{setup\PYGZus{}base}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} setup units}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{       With Units}
\PYG{l+s+s1}{           .Geometry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{um}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Frequency }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{THz}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Voltage }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{V}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Resistance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Ohm}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Inductance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .TemperatureUnit  }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Kelvin}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Time }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ns}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Current }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{A}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Conductance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Siemens}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{           .Capacitance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{F}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{       End With}
\PYG{l+s+s1}{       }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{setup units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} set the wavelength range}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        Solver.WavelengthRange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{4}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{setup frequency range}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} setup background}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        Plot.DrawBox True}
\PYG{l+s+s1}{        With Background}
\PYG{l+s+s1}{             .Type }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Normal}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Epsilon }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Mu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Rho }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1.204}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ThermalType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Normal}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ThermalConductivity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.026}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .HeatCapacity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1.005}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .XminSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .XmaxSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .YminSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .YmaxSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ZminSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ZmaxSpace }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{setup background}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} define Floquet port boundaries}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With FloquetPort}
\PYG{l+s+s1}{             .Reset}
\PYG{l+s+s1}{             .SetDialogTheta }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetDialogPhi }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetSortCode }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{+beta/pw}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetCustomizedListFlag }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Port }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Zmin}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetNumberOfModesConsidered }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Port }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Zmax}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetNumberOfModesConsidered }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set Floquet port boundaries}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} define parameters exist}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        MakeSureParameterExists }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        SetParameterDescription }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{spherical angle of incident plane wave}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        MakeSureParameterExists }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{phi}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        SetParameterDescription }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{phi}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{spherical angle of incident plane wave}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set parameters exist}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} define boundaries, the open boundaries define floquet port}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Boundary}
\PYG{l+s+s1}{             .Xmin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{unit cell}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Xmax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{unit cell}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Ymin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{unit cell}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Ymax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{unit cell}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Zmin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{expanded open}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Zmax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{expanded open}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Xsymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Ysymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Zsymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .XPeriodicShift }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .YPeriodicShift }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ZPeriodicShift }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .PeriodicUseConstantAngles }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetPeriodicBoundaryAngles }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{theta}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{phi}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .SetPeriodicBoundaryAnglesDirection }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{inward}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .UnitCellFitToBoundingBox }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .UnitCellDs1 }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .UnitCellDs2 }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .UnitCellAngle }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{90.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With    }
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set boundaries}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} set tet mesh as default}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Mesh}
\PYG{l+s+s1}{             .MeshType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tetrahedral}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set mesh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} FD solver excitation with incoming plane wave at Zmax}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With FDSolver}
\PYG{l+s+s1}{             .Reset}
\PYG{l+s+s1}{             .Stimulation }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{List}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{List}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .ResetExcitationList}
\PYG{l+s+s1}{             .AddToExcitationList }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Zmax}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{TE(0,0);TM(0,0)}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .LowFrequencyStabilization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set FD solver}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} change problem type}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        ChangeProblemType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Optical}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{change problem type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With MeshSettings}
\PYG{l+s+s1}{             .SetMeshType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{             .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Version}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, 1}\PYG{l+s+s1}{\PYGZpc{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{MeshSettings}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Mesh}
\PYG{l+s+s1}{             .MeshType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tetrahedral}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cset meshtype}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} set the solver type}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        ChangeSolverType(}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{HF Frequency Domain}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{)}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set the solver type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}component}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{num}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} set component}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        Component.New }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{component}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{num}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{new component}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2 \PYGZhy{} material}
\PYG{k}{def} \PYG{n+nf}{define\PYGZus{}material\PYGZus{}general}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{index}\PYG{p}{,} \PYG{n}{RGB}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{transparency}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Material }
\PYG{l+s+s1}{         .Reset }
\PYG{l+s+s1}{         .Name }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Folder }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Rho }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ThermalType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Normal}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ThermalConductivity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .SpecificHeat }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{J/K/kg}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .DynamicViscosity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Emissivity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MetabolicRate }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .VoxelConvection }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .BloodFlow }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MechanicsType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Unused}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .FrqType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{all}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Type }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Normal}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaterialUnit }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Frequency}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{THz}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaterialUnit }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Geometry}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{um}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaterialUnit }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ns}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaterialUnit }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Temperature}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Kelvin}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Epsilon }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Mu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Sigma }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanD }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDFreq }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDGiven }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDModel }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ConstTanD}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .EnableUserConstTanDModelOrderEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ConstTanDModelOrderEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .SetElParametricConductivity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ReferenceCoordSystem }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Global}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .CoordSystemType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Cartesian}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .SigmaM }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDM }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDMFreq }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDMGiven }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .TanDMModel }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ConstTanD}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .EnableUserConstTanDModelOrderMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ConstTanDModelOrderMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .SetMagParametricConductivity }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .DispModelEps  }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{None}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .DispModelMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{None}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .DispersiveFittingSchemeEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Nth Order}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaximalOrderNthModelFitEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ErrorLimitNthModelFitEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseOnlyDataInSimFreqRangeNthModelEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .DispersiveFittingSchemeMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Nth Order}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaximalOrderNthModelFitMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ErrorLimitNthModelFitMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseOnlyDataInSimFreqRangeNthModelMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseGeneralDispersionEps }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseGeneralDispersionMu }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NLAnisotropy }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NLAStackingFactor }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NLADirectionX }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NLADirectionY }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NLADirectionZ }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Colour }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2[2]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Wireframe }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Reflection }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Allowoutline }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Transparentoutline }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Transparency }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}3\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Create}
\PYG{l+s+s1}{        End With}
\PYG{l+s+s1}{        }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{index}\PYG{p}{,} \PYG{n}{RGB}\PYG{p}{,} \PYG{n}{transparency}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define material: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2 \PYGZhy{} material}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}material\PYGZus{}color}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{RGB}\PYG{p}{,} \PYG{n}{transparency}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Material }
\PYG{l+s+s1}{         .Name }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Folder }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Colour }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1[2]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Wireframe }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Reflection }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Allowoutline }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Transparentoutline }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Transparency }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ChangeColour }
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{RGB}\PYG{p}{,} \PYG{n}{transparency}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define material: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2 \PYGZhy{} model}
\PYG{k}{def} \PYG{n+nf}{brick}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{Xrange}\PYG{p}{,} \PYG{n}{Yrange}\PYG{p}{,} \PYG{n}{Zrange}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{    With Brick}
\PYG{l+s+s1}{     .Reset }
\PYG{l+s+s1}{     .Name }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Component }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Material }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Xrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}3[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}3[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Yrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}4[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}4[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Zrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}5[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}5[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{     .Create}
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{Xrange}\PYG{p}{,} \PYG{n}{Yrange}\PYG{p}{,} \PYG{n}{Zrange}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define brick: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2 \PYGZhy{}model}
\PYG{k}{def} \PYG{n+nf}{cylinder}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{Rrange}\PYG{p}{,} \PYG{n}{Zrange}\PYG{p}{,} \PYG{n}{center}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{segments}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Cylinder }
\PYG{l+s+s1}{         .Reset }
\PYG{l+s+s1}{         .Name }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Component }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}1\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Material }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .OuterRadius }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}3[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .InnerRadius }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}3[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Axis }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{z}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Zrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}4[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}4[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Xcenter }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}5[0]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Ycenter }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}5[1]\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Segments }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}6\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Create }
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{Rrange}\PYG{p}{,} \PYG{n}{Zrange}\PYG{p}{,} \PYG{n}{center}\PYG{p}{,} \PYG{n}{segments}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define cylinder: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 2 \PYGZhy{} boolean opt}
\PYG{k}{def} \PYG{n+nf}{boolean\PYGZus{}insert}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{comp1}\PYG{p}{,} \PYG{n}{name1}\PYG{p}{,} \PYG{n}{comp2}\PYG{p}{,} \PYG{n}{name2}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{    Solid.Insert }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}1\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}2\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}3\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{comp1}\PYG{p}{,} \PYG{n}{name1}\PYG{p}{,} \PYG{n}{comp2}\PYG{p}{,} \PYG{n}{name2}\PYG{p}{)}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{boolean insert shape: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{comp1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name1}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{, }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{comp2}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{name2}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 3 \PYGZhy{} port (不含极化角)}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}port\PYGZus{}full}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{num}\PYG{p}{,} \PYG{n}{orientation}\PYG{p}{,} \PYG{n}{mode\PYGZus{}no}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Port }
\PYG{l+s+s1}{         .Reset }
\PYG{l+s+s1}{         .PortNumber }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Label }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Folder }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .NumberOfModes }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mode\PYGZus{}no}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AdjustPolarization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .PolarizationAngle }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ReferencePlaneDistance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .TextSize }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{50}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .TextMaxLimit }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Coordinates }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Full}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Orientation }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{orientation}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .PortOnBound }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ClipPickedPortToBound }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Xrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Yrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Zrange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .XrangeAdd }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .YrangeAdd }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ZrangeAdd }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SingleEnded }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .WaveguideMonitor }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Create }
\PYG{l+s+s1}{    End With }
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define port: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{num}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 4 \PYGZhy{} boundary}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}boundary}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{x\PYGZus{}bc}\PYG{p}{,} \PYG{n}{y\PYGZus{}bc}\PYG{p}{,} \PYG{n}{z\PYGZus{}bc}\PYG{p}{,} \PYG{n}{symmetry}\PYG{o}{=}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With Boundary}
\PYG{l+s+s1}{         .Xmin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{x\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Xmax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{x\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Ymin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{y\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Ymax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{y\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Zmin }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{z\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Zmax }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{z\PYGZus{}bc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Xsymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{symmetry}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Ysymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{symmetry}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .Zsymmetry }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{symmetry}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .ApplyInAllDirections }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define boundary condition}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 5 \PYGZhy{} create mesh}
\PYG{k}{def} \PYG{n+nf}{create\PYGZus{}mesh}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{meshgroup}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{    Group.Add }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{mesh}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{create group: }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 5 \PYGZhy{} set mesh accuracy}
\PYG{k}{def} \PYG{n+nf}{mesh\PYGZus{}setting}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{meshgroup}\PYG{p}{,} \PYG{n}{mesh\PYGZus{}size}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        With MeshSettings}
\PYG{l+s+s1}{         With .ItemMeshSettings (}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{group\PYGZdl{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{)}
\PYG{l+s+s1}{              .SetMeshType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{LayerStackup}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Automatic}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{LocalAutomaticEdgeRefinement}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{LocalAutomaticEdgeRefinementOverwrite}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, 0}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{MaterialIndependent}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, 0}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{OctreeSizeFaces}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{PatchIndependent}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, 0}
\PYG{l+s+s1}{              .Set }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Size}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{mesh\PYGZus{}size}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         End With}
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set local mesh properties for : }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 5 \PYGZhy{} add items to group}
\PYG{k}{def} \PYG{n+nf}{mesh\PYGZus{}add\PYGZus{}items}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{item}\PYG{p}{,} \PYG{n}{meshgroup}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{    Group.AddItem }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{solid\PYGZdl{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{comp}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{item}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{add items to group : }\PYG{l+s+si}{\PYGZob{}}\PYG{n}{comp}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{:}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{meshgroup}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 6 \PYGZhy{} wavelength}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}wavelength\PYGZus{}range}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{wl\PYGZus{}range}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{    Solver.WavelengthRange }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{wl\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{wl\PYGZus{}range}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{define wavelength range}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 6 \PYGZhy{} FD solver (equidistant)}
\PYG{k}{def} \PYG{n+nf}{set\PYGZus{}FD\PYGZus{}solver}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{source\PYGZus{}type}\PYG{p}{,} \PYG{n}{nfreq}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{vba} \PYG{o}{=} \PYG{l+s+sa}{f}\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
\PYG{l+s+s1}{        Mesh.SetCreator }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{High Frequency}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{    }
\PYG{l+s+s1}{    With FDSolver}
\PYG{l+s+s1}{         .Reset }
\PYG{l+s+s1}{         .SetMethod }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tetrahedral}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{General purpose}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .OrderTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Second}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .OrderSrf }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{First}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Stimulation }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{source\PYGZus{}type}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{All}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ResetExcitationList }
\PYG{l+s+s1}{         .AutoNormImpedance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .NormingImpedance }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{50}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ModesOnly }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ConsiderPortLossesTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetShieldAllPorts }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AccuracyHex }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1e\PYGZhy{}6}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AccuracyTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1e\PYGZhy{}4}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AccuracySrf }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1e\PYGZhy{}3}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .LimitIterations }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MaxIterations }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetCalcBlockExcitationsInParallel }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .StoreAllResults }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .StoreResultsInCache }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseHelmholtzEquation }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .LowFrequencyStabilization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Type }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Auto}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MeshAdaptionHex }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MeshAdaptionTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AcceleratedRestart }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .FreqDistAdaptMode }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Distributed}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .NewIterativeSolver }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .TDCompatibleMaterials }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ExtrudeOpenBC }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetOpenBCTypeHex }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Default}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetOpenBCTypeTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Default}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AddMonitorSamples }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .CalcPowerLoss }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .CalcPowerLossPerComponent }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .StoreSolutionCoefficients }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseDoublePrecision }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseDoublePrecision\PYGZus{}ML }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MixedOrderSrf }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MixedOrderTet }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .PreconditionerAccuracyIntEq }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.15}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MLFMMAccuracy }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Default}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MinMLFMMBoxSize }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.3}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseCFIEForCPECIntEq }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseFastRCSSweepIntEq }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{false}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseSensitivityAnalysis }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .RemoveAllStopCriteria }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Hex}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{All S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Hex}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Reflection S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Hex}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Transmission S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Hex}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .RemoveAllStopCriteria }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{All S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Reflection S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Transmission S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{All Probes}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.05}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Tet}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .RemoveAllStopCriteria }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Srf}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{All S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Srf}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Reflection S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Srf}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .AddStopCriterion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Transmission S\PYGZhy{}Parameters}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.01}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Srf}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .SweepMinimumSamples }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{3}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetNumberOfResultDataSamples }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1001}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetResultDataSamplingMode }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Automatic}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SweepWeightEvanescent }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AccuracyROM }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{1e\PYGZhy{}4}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AddSampleInterval }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{nfreq}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Equidistant}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .AddInactiveSampleInterval }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Automatic}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .MPIParallelization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseDistributedComputing }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NetworkComputingStrategy }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{RunRemote}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .NetworkComputingJobCount }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{3}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .UseParallelization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaxCPUs }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{128}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{         .MaximumNumberOfCPUDevices }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{2}\PYG{l+s+s1}{\PYGZdq{}}
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }
\PYG{l+s+s1}{    With IESolver}
\PYG{l+s+s1}{         .Reset }
\PYG{l+s+s1}{         .UseFastFrequencySweep }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseIEGroundPlane }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetRealGroundMaterialName }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .CalcFarFieldInRealGround }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .RealGroundModelType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Auto}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .PreconditionerType }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Auto}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ExtendThinWireModelByWireNubs }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }
\PYG{l+s+s1}{    With IESolver}
\PYG{l+s+s1}{         .SetFMMFFCalcStopLevel }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetFMMFFCalcNumInterpPoints }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{6}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .UseFMMFarfieldCalc }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetCFIEAlpha }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.500000}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .LowFrequencyStabilization }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .LowFrequencyStabilizationML }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .Multilayer }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetiMoMACC\PYGZus{}I }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0001}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetiMoMACC\PYGZus{}M }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.0001}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .DeembedExternalPorts }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetOpenBC\PYGZus{}XY }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .OldRCSSweepDefintion }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{False}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetRCSOptimizationProperties }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{100}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{, }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0.00001}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetAccuracySetting }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Custom}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .CalculateSParaforFieldsources }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .ModeTrackingCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .NumberOfModesCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{3}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .StartFrequencyCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZhy{}1.0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetAccuracySettingCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Default}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .FrequencySamplesCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{0}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .SetMemSettingCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Auto}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{         .CalculateModalWeightingCoefficientsCMA }\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{True}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ }
\PYG{l+s+s1}{    End With}
\PYG{l+s+s1}{    }\PYG{l+s+s1}{\PYGZsq{}\PYGZsq{}\PYGZsq{}}
    \PYG{n}{modeler}\PYG{o}{.}\PYG{n}{add\PYGZus{}to\PYGZus{}history}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{set FD solver}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vba}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} step 8 \PYGZhy{} get S}
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}S}\PYG{p}{(}\PYG{n}{mws}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{project} \PYG{o}{=} \PYG{n}{results}\PYG{o}{.}\PYG{n}{ProjectFile}\PYG{p}{(}\PYG{n}{mws}\PYG{o}{.}\PYG{n}{filename}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{allow\PYGZus{}interactive}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
    \PYG{n}{wl} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{project}\PYG{o}{.}\PYG{n}{get\PYGZus{}3d}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}item}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1D Results}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S\PYGZhy{}Parameters}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S1,1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}xdata}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{s11} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{project}\PYG{o}{.}\PYG{n}{get\PYGZus{}3d}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}item}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1D Results}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S\PYGZhy{}Parameters}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S1,1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}ydata}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{s21} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{project}\PYG{o}{.}\PYG{n}{get\PYGZus{}3d}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}result\PYGZus{}item}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1D Results}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S\PYGZhy{}Parameters}\PYG{l+s+s2}{\PYGZbs{}}\PYG{l+s+s2}{S2,1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get\PYGZus{}ydata}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{s11\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{s11}\PYG{p}{)}
    \PYG{n}{s21\PYGZus{}norm} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{s21}\PYG{p}{)}
    \PYG{n}{result} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{wl}\PYG{p}{,} \PYG{n}{s11\PYGZus{}norm}\PYG{p}{,} \PYG{n}{s21\PYGZus{}norm}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{result}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} step 0: 初始化}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{n}{save\PYGZus{}path} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} save for cst files}
\PYG{n}{save\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{unity\PYGZus{}CST\PYGZus{}test.cst}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{save\PYGZus{}name} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{save\PYGZus{}path}\PYG{p}{,} \PYG{n}{save\PYGZus{}name}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Working file: }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{save\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{cst} \PYG{o}{=} \PYG{n}{interface}\PYG{o}{.}\PYG{n}{DesignEnvironment}\PYG{p}{(}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} create new cst project and save it}
\PYG{n}{mws} \PYG{o}{=} \PYG{n}{cst}\PYG{o}{.}\PYG{n}{new\PYGZus{}mws}\PYG{p}{(}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} mws.save(path=os.path.join(save\PYGZus{}path, save\PYGZus{}name))}
\PYG{n}{mws}\PYG{o}{.}\PYG{n}{save}\PYG{p}{(}\PYG{n}{path}\PYG{o}{=}\PYG{n}{save\PYGZus{}name}\PYG{p}{)}

\PYG{n}{mws}\PYG{o}{.}\PYG{n}{activate}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{modeler} \PYG{o}{=} \PYG{n}{mws}\PYG{o}{.}\PYG{n}{modeler}  \PYG{c+c1}{\PYGZsh{} define the modeler to create the unit cell structure}

\PYG{n}{setup\PYGZus{}base}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} 初始环境}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} step 1: 建立坐标需要的变量参数}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{n}{parameter} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}max}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.6}\PYG{p}{,}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}min}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{1}\PYG{p}{,}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nfreq}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{50}\PYG{p}{,}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dp}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.66}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} sub\PYGZus{}len}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dsub}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{2.5}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} sub\PYGZus{}thickness}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+m+mf}{0.206}\PYG{p}{,}       \PYG{c+c1}{\PYGZsh{} cylinder\PYGZus{}r}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c\PYGZus{}h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+m+mf}{0.22}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} cylinder\PYGZus{}h}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{source\PYGZus{}z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.8}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} source\PYGZus{}position}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sim\PYGZus{}z\PYGZus{}span}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{4}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} fdtd region}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZus{}z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.9}\PYG{p}{,}        \PYG{c+c1}{\PYGZsh{} T monitor position}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1.5}\PYG{p}{,}         \PYG{c+c1}{\PYGZsh{} sub\PYGZus{}n}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{n2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{3.4}\PYG{p}{,}         \PYG{c+c1}{\PYGZsh{} die\PYGZus{}n}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{resolution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{50}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} mesh}
             \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auto shutoff min}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{1e\PYGZhy{}9}   \PYG{c+c1}{\PYGZsh{} CST no need}
             \PYG{p}{\PYGZcb{}}   \PYG{c+c1}{\PYGZsh{}  统一全局参数变量}
\PYG{n}{par} \PYG{o}{=} \PYG{n}{parameter}
\PYG{n}{c} \PYG{o}{=} \PYG{l+m+mf}{3e8}

\PYG{n}{dp} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dp}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{dsub} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{dsub}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{c\PYGZus{}r} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{c\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{c\PYGZus{}h} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{c\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{source\PYGZus{}z} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{source\PYGZus{}z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{sim\PYGZus{}z\PYGZus{}span} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sim\PYGZus{}z\PYGZus{}span}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{T\PYGZus{}z} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T\PYGZus{}z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{n1} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{n2} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{n2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{wl\PYGZus{}min} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}min}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{wl\PYGZus{}max} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}max}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{nfreq} \PYG{o}{=} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nfreq}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}

\PYG{n}{fmax} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}min}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{fmin} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{wl\PYGZus{}max}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{fcen} \PYG{o}{=} \PYG{p}{(}\PYG{n}{fmin} \PYG{o}{+} \PYG{n}{fmax}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}

\PYG{n}{mesh\PYGZus{}accuracy} \PYG{o}{=} \PYG{l+m+mi}{1} \PYG{o}{/} \PYG{n}{par}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{resolution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{*} \PYG{l+m+mi}{2}


\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 2: 添加模型结构}
\PYG{c+c1}{\PYGZsh{}  ******  CST 需先添加材料(如给定折射率，也需先定义材料)， 设定component}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}前端展示}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} 创建预览要素}
\PYG{n}{tree} \PYG{o}{=} \PYG{n}{ModelTree}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Model}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Block}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{c\PYGZus{}r}\PYG{p}{,} \PYG{n}{c\PYGZus{}r}\PYG{p}{,}\PYG{n}{c\PYGZus{}h}\PYG{p}{,}\PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Cylinder}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{line}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{true}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{source}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{source\PYGZus{}z}\PYG{p}{)}\PYG{p}{,} \PYG{n}{target}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{wl\PYGZus{}min} \PYG{k}{if} \PYG{n}{source\PYGZus{}z} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Arrow}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Light Source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{source}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{opacity}\PYG{o}{=}\PYG{l+m+mf}{0.4}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sim Area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{create\PYGZus{}model}\PYG{p}{(}\PYG{n}{size}\PYG{o}{=}\PYG{p}{(}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{)}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Box}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tree}\PYG{o}{.}\PYG{n}{add\PYGZus{}node}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{c1 \PYGZhy{} Block}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} add new component}
\PYG{c+c1}{\PYGZsh{} 可以默认本来就有两个 component}
\PYG{n}{set\PYGZus{}component}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} 新建 component1}
\PYG{n}{set\PYGZus{}component}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}   \PYG{c+c1}{\PYGZsh{} 新建 component2}

\PYG{c+c1}{\PYGZsh{} add material}
\PYG{n}{define\PYGZus{}material\PYGZus{}general}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sub\PYGZus{}material}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n1} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{RGB}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mf}{0.752941}\PYG{p}{,} \PYG{l+m+mf}{0.752941}\PYG{p}{,} \PYG{l+m+mf}{0.752941}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{define\PYGZus{}material\PYGZus{}general}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{die\PYGZus{}material}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{n2} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{set\PYGZus{}material\PYGZus{}color}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Vacuum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.8}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{60}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} add substrate}
\PYG{c+c1}{\PYGZsh{} **** 结构统一参数：center, span}
\PYG{n}{center} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{dsub}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{o}{\PYGZhy{}}\PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{span} \PYG{o}{=} \PYG{p}{[}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{dsub}\PYG{p}{]}

\PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{substrate}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{comp} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{component1}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{material} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sub\PYGZus{}material}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{x\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{y\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{z\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{brick}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{x\PYGZus{}range}\PYG{p}{,} \PYG{n}{y\PYGZus{}range}\PYG{p}{,} \PYG{n}{z\PYGZus{}range}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} add dielectric}
\PYG{c+c1}{\PYGZsh{} **** 结构统一参数：center, radius, height}
\PYG{n}{center} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{radius} \PYG{o}{=} \PYG{n}{c\PYGZus{}r}
\PYG{n}{height} \PYG{o}{=} \PYG{n}{c\PYGZus{}h}

\PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dielectric}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{comp} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{component2}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{material} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{die\PYGZus{}material}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{R\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{radius}\PYG{p}{]}
\PYG{n}{z\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{height}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{+}\PYG{n}{height}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{cylinder}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{R\PYGZus{}range}\PYG{p}{,} \PYG{n}{z\PYGZus{}range}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} add vacuum}
\PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{vacuum}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{comp} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{component2}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{material} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Vacuum}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{center} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{/}\PYG{l+m+mi}{4} \PYG{o}{\PYGZhy{}} \PYG{n}{c\PYGZus{}h}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{span} \PYG{o}{=} \PYG{p}{[}\PYG{n}{dp}\PYG{p}{,} \PYG{n}{dp}\PYG{p}{,} \PYG{n}{sim\PYGZus{}z\PYGZus{}span}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{x\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{y\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{z\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{+} \PYG{n}{span}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n}{brick}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{comp}\PYG{p}{,} \PYG{n}{material}\PYG{p}{,} \PYG{n}{x\PYGZus{}range}\PYG{p}{,} \PYG{n}{y\PYGZus{}range}\PYG{p}{,} \PYG{n}{z\PYGZus{}range}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} boolean insert}
\PYG{n}{boolean\PYGZus{}insert}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{component2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{vacuum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{component2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dielectric}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 3: 添加源}
\PYG{c+c1}{\PYGZsh{}  ******  CST 频域仿真无需单独设源，port可作源，这一步设置端口}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{c+c1}{\PYGZsh{} **** 结构统一参数：center}
\PYG{n}{center} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{T\PYGZus{}z}\PYG{p}{]}
\PYG{k}{if} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
    \PYG{n}{port\PYGZus{}pos} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zmax}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{port\PYGZus{}pos} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zmin}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{set\PYGZus{}port\PYGZus{}full}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{port\PYGZus{}pos}\PYG{p}{)}

\PYG{n}{source\PYGZus{}type} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{1}\PYG{l+s+s1}{\PYGZsq{}}        \PYG{c+c1}{\PYGZsh{} choose \PYGZsq{}1/2/All\PYGZsq{} , used in step 6}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 4: 仿真设置}
\PYG{c+c1}{\PYGZsh{}  ******  CST: 边界条件}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{x\PYGZus{}bc} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{magnetic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{magnetic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{y\PYGZus{}bc} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{electric}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{electric}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{z\PYGZus{}bc} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{open}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{open}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{symmetry} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{magnetic}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{electric}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{set\PYGZus{}boundary}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{x\PYGZus{}bc}\PYG{p}{,} \PYG{n}{y\PYGZus{}bc}\PYG{p}{,} \PYG{n}{z\PYGZus{}bc}\PYG{p}{,} \PYG{n}{symmetry}\PYG{o}{=}\PYG{n}{symmetry}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 5: 网格设置}
\PYG{c+c1}{\PYGZsh{}          CST 需指定加 mesh 的 body，精度可与meep统一为 resolution}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} create\PYGZus{}mesh(modeler, \PYGZsq{}meshgroup1\PYGZsq{})}
\PYG{c+c1}{\PYGZsh{} mesh\PYGZus{}setting(modeler, \PYGZsq{}meshgroup1\PYGZsq{}, mesh\PYGZus{}accuracy)}
\PYG{c+c1}{\PYGZsh{} mesh\PYGZus{}add\PYGZus{}items(modeler, \PYGZsq{}component2\PYGZsq{}, \PYGZsq{}dielectric\PYGZsq{}, \PYGZsq{}meshgroup1\PYGZsq{})}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 6: 设置监视器}
\PYG{c+c1}{\PYGZsh{}          CST中的 port既可当源，又可作监视器，pos 无需再设，设置采样点数与波长范围即可}
\PYG{c+c1}{\PYGZsh{}          设置采样点数，通过求解器设置}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{} **** 结构统一参数：center}
\PYG{n}{center} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0} \PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{T\PYGZus{}z}\PYG{p}{]}

\PYG{k}{if} \PYG{n}{center}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{:}
    \PYG{n}{monitor\PYGZus{}pos} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zmax}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{monitor\PYGZus{}pos} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{zmin}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{set\PYGZus{}port\PYGZus{}full}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{monitor\PYGZus{}pos}\PYG{p}{)}

\PYG{n}{wl\PYGZus{}range} \PYG{o}{=} \PYG{p}{[}\PYG{n}{wl\PYGZus{}min}\PYG{p}{,} \PYG{n}{wl\PYGZus{}max}\PYG{p}{]}
\PYG{n}{set\PYGZus{}wavelength\PYGZus{}range}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{wl\PYGZus{}range}\PYG{p}{)}

\PYG{n}{set\PYGZus{}FD\PYGZus{}solver}\PYG{p}{(}\PYG{n}{modeler}\PYG{p}{,} \PYG{n}{source\PYGZus{}type}\PYG{p}{,} \PYG{n}{nfreq}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 7: 仿真运行}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst正在运行，请等待........................}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{modeler}\PYG{o}{.}\PYG{n}{run\PYGZus{}solver}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 8: 数据提取}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{result} \PYG{o}{=} \PYG{n}{get\PYGZus{}S}\PYG{p}{(}\PYG{n}{mws}\PYG{p}{)}

\PYG{n}{freq} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{T} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}
\PYG{n}{R} \PYG{o}{=} \PYG{n}{result}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{已提取数据}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{c+c1}{\PYGZsh{}  step 9: 数据处理}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{l+m+mf}{1e8} \PYG{o}{/} \PYG{n}{freq} \PYG{o}{/} \PYG{l+m+mf}{1e6}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{T}\PYG{p}{,} \PYG{n}{T}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflectance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{l+m+mf}{1e8} \PYG{o}{/} \PYG{n}{freq} \PYG{o}{/} \PYG{l+m+mf}{1e6}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{R}\PYG{p}{,} \PYG{n}{R}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmittance}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mi}{3} \PYG{o}{*} \PYG{l+m+mf}{1e8} \PYG{o}{/} \PYG{n}{freq} \PYG{o}{/} \PYG{l+m+mf}{1e6}\PYG{p}{,} \PYG{l+m+mi}{1} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{R}\PYG{p}{,} \PYG{n}{R}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{T}\PYG{p}{,} \PYG{n}{T}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{wavelength (μm)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{upper right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} np.savetxt(\PYGZdq{}meta\PYGZus{}T.txt\PYGZdq{}, T)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst\PYGZus{}unity\PYGZus{}AOM.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{wl}\PYG{o}{=} \PYG{l+m+mi}{3}\PYG{o}{*} \PYG{l+m+mf}{1e8} \PYG{o}{/} \PYG{n}{freq} \PYG{o}{/} \PYG{l+m+mf}{1e6}
\PYG{n}{R}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{R}\PYG{p}{,} \PYG{n}{R}\PYG{p}{)}
\PYG{n}{T}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{multiply}\PYG{p}{(}\PYG{n}{T}\PYG{p}{,} \PYG{n}{T}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}unityCode.save\PYGZus{}data(wls\PYGZus{}cst = wl.tolist())}
\PYG{c+c1}{\PYGZsh{}unityCode.save\PYGZus{}data(Rs\PYGZus{}cst = np.multiply(R, R).tolist())}
\PYG{c+c1}{\PYGZsh{}unityCode.save\PYGZus{}data(Ts\PYGZus{}cst = np.multiply(R, R).tolist())}
\PYG{n}{wls\PYGZus{}cst} \PYG{o}{=} \PYG{n}{wl}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Rs\PYGZus{}cst} \PYG{o}{=} \PYG{n}{T}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Ts\PYGZus{}cst} \PYG{o}{=} \PYG{n}{R}\PYG{o}{.}\PYG{n}{tolist}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{wl} \PYG{o}{=}\PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wls\PYGZus{}rcwa}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wl}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{wls\PYGZus{}rcwa}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mi}{1000}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} 画四类环境下的对比光谱图}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum}\PYG{p}{,}\PYG{n}{Ts\PYGZus{}lum}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}meep}\PYG{p}{,}\PYG{n}{Ts\PYGZus{}meep}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{Ts\PYGZus{}rcwa}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rcwa}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}cst}\PYG{p}{,}\PYG{n}{Ts\PYGZus{}cst}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cst}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{transmission}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Wavelength (μm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{transmission\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}   需要展示的数据图}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{transmission\PYGZus{}四类环境对比}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{transmission\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum}\PYG{p}{,}\PYG{n}{Rs\PYGZus{}lum}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}meep}\PYG{p}{,}\PYG{n}{Rs\PYGZus{}meep}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wl}\PYG{p}{,}\PYG{n}{Rs\PYGZus{}rcwa}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rcwa}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}cst}\PYG{p}{,}\PYG{n}{Rs\PYGZus{}cst}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cst}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reflection}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Wavelength (μm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reflection\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}   需要展示的数据图}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reflection\PYGZus{}四类环境对比}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{reflection\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{Rs\PYGZus{}lum}\PYG{o}{\PYGZhy{}}\PYG{n}{Ts\PYGZus{}lum}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{blue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lum}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}meep}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{Rs\PYGZus{}meep}\PYG{o}{\PYGZhy{}}\PYG{n}{Ts\PYGZus{}meep}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{meep}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}lum}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{Rs\PYGZus{}rcwa}\PYG{o}{\PYGZhy{}}\PYG{n}{Ts\PYGZus{}rcwa}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rcwa}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{wls\PYGZus{}cst}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{Rs\PYGZus{}cst}\PYG{o}{\PYGZhy{}}\PYG{n}{Ts\PYGZus{}cst}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{orange}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cst}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{loss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Wavelength (μm)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{loss\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}        \PYG{c+c1}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}   需要展示的数据图}
\PYG{n}{device}\PYG{o}{.}\PYG{n}{save\PYGZus{}fig}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{loss\PYGZus{}四类环境对比}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{n}{file\PYGZus{}path}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{loss\PYGZus{}四类环境对比.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}



\PYG{n}{sim\PYGZus{}end}\PYG{p}{(}\PYG{n}{backend}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cst}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{仿真完毕}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
示例运行后的结果展示：

\sphinxAtStartPar


\sphinxAtStartPar
\sphinxincludegraphics{{compare}.png}







\renewcommand{\indexname}{索引}
\footnotesize\raggedright\printindex
\end{document}